import{i as S,p as J,f as de,_ as fe,u as he,r as ye}from"./format-CRgx78oe.js";import{s as ke,S as be,c as Ie,d as xe,a as Ce,b as ze,e as Te,f as we}from"./SendMessage-BMjrCabi.js";import{d as Y,i as y,c as r,o as n,_ as ee,m as ue,K as Se,G as _e,u as $e,q as Me,e,b as m,w as V,f as v,F as $,j as P,a as X,r as x,g as _,I as T,E as H,D as g,N as De,S as Ne,p as ve,n as F,A as W,aT as me,C as Ee,aQ as Re,e5 as Be}from"./index-DrbzVNl6.js";import Fe from"./Reconnection-BJKzo9EH.js";/* empty css             *//* empty css                                                                    */import{P as Ve}from"./Pagination-wR9huHyl.js";import{g as je}from"./product-DEi2MlvQ.js";import Ue from"./OrderImList-T8ZRrNJY.js";import{e as Oe}from"./Emoji-DFvwznDF.js";import"./ReconnectionList-Rejb_FPF.js";import"./StatusDot-eKxl7wC-.js";import"./conversation-rd7RS6Jg.js";import"./order-DqMQuu0g.js";import"./index-CeQDmMxd.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-DqYSRv0_.js";const Le=["innerHTML"],Pe=Y({__name:"emojiHtml",props:{content:{type:String,default:""}},setup(k){const N=k,M=y("");M.value=d(N.content,Oe);function d(I,p){const b=new RegExp(`(${p.map(i=>i.name).join("|")})`,"g");return I.replace(/\[|\]/g,"").replace(b,i=>{const l=p.find(C=>C.name===i);return l?"<img class='emoji' src='http://oss.tigshop.com/official/emoji/"+l.id+".png'>":i})}return(I,p)=>(n(),r("div",{innerHTML:M.value},null,8,Le))}}),He=ee(Pe,[["__scopeId","data-v-7e152687"]]),qe={class:"goods-search-container"},Ae={class:"goods-toolbar"},Ge={class:"goods-recommend-list"},Ze={class:"check-box"},Ke=["onClick"],Qe=["onClick"],We={class:"name"},Je={class:"price"},Xe={class:"goods-choosed-box"},Ye={key:0,class:"page"},et={class:"bot"},tt={key:0,class:"goods-choosed-box-left"},st={key:1,class:"goods-choosed-box-left-have"},at={class:"im"},ot=["onClick"],nt=Y({__name:"SelectImProduct",props:ue({messageInfo:{type:Object,default:{}}},{linkSelectData:{type:Array,default:[]},linkSelectDataModifiers:{}}),emits:ue(["sendMessage"],["update:linkSelectData"]),setup(k,{emit:N}){const M=k,d=y(!0),I=y(0),p=Se(),b=y([]),i=_e({page:1,size:p.get("pageSize"),sortField:"",sortOrder:"",keyword:""});$e(k,"linkSelectData");const l=y([]),C=async()=>{d.value=!0;try{const c=await je({...i});b.value=c.records,b.value.forEach(s=>{s.check=l.value.some(f=>f.productId===s.productId)}),I.value=c.total}catch(c){T.error(c.message)}finally{d.value=!1}},D=c=>{const s=l.value.findIndex(f=>f.productId===c.productId);s!==-1?(l.value.splice(s,1),c.check=!1):l.value.length<3?(l.value.push(c),c.check=!0):T.error("一次最多发送三个商品")},E=c=>{if(c.check)D(c);else{const s=l.value.findIndex(f=>f.productId===c.productId);s!==-1&&l.value.splice(s,1)}},q=c=>{const s=l.value.splice(c,1)[0],f=b.value.findIndex(z=>z.productId===s.productId);f!==-1&&(b.value[f].check=!1)},w=()=>{j()},j=()=>{l.value.forEach(c=>{Z(c)})},A=Ne("receiveValueFromGrandChild"),G=N,Z=async c=>{try{let s={};Object.assign(s,M.messageInfo,{content:{messageType:"custom",product:c||""}});const f=await ke(s);G("sendMessage",f),A(f),l.value=[],b.value.forEach(z=>z.check=!1)}catch(s){console.log(s)}finally{}};return Me(()=>{C()}),(c,s)=>{const f=x("TigInput"),z=x("el-button"),K=x("el-space"),R=x("el-checkbox"),B=x("el-image"),U=x("el-empty"),Q=x("a-spin");return n(),r("div",qe,[e("div",Ae,[m(K,null,{default:V(()=>[m(f,{width:"190px",modelValue:i.keyword,"onUpdate:modelValue":s[0]||(s[0]=u=>i.keyword=u),placeholder:"商品名称/货号"},null,8,["modelValue"]),m(z,{onClick:C},{default:V(()=>s[3]||(s[3]=[H("搜索")])),_:1})]),_:1})]),e("div",Ge,[d.value?v("",!0):(n(),r($,{key:0},[I.value>0?(n(!0),r($,{key:0},X(b.value,u=>(n(),r("div",{key:u.productId,class:"product-item"},[e("div",Ze,[m(R,{modelValue:u.check,"onUpdate:modelValue":h=>u.check=h,onChange:h=>E(u)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),e("div",{class:"image-box",onClick:h=>D(u)},[m(B,{fit:"cover",class:"image",src:_(S)(u.picThumb)},null,8,["src"])],8,Ke),e("div",{class:"info-box",onClick:h=>D(u)},[e("div",We,g(u.productName),1),e("div",Je,g(_(J)(u.productPrice)),1)],8,Qe)]))),128)):(n(),P(U,{key:1,description:"暂无商品～"}))],64)),m(Q,{spinning:d.value,style:{width:"100%","margin-top":"100px"}},null,8,["spinning"])]),e("div",Xe,[I.value>0?(n(),r("div",Ye,[m(_(Ve),{page:i.page,"onUpdate:page":s[1]||(s[1]=u=>i.page=u),size:i.size,"onUpdate:size":s[2]||(s[2]=u=>i.size=u),total:I.value,onCallback:C,layout:"slot, prev, next",background:!1},null,8,["page","size","total"])])):v("",!0),e("div",et,[l.value.length===0?(n(),r("div",tt,s[4]||(s[4]=[e("div",null,"尚未选择商品",-1)]))):(n(),r("div",st,[s[5]||(s[5]=e("div",null,"已选择",-1)),(n(!0),r($,null,X(l.value,(u,h)=>(n(),r("div",{class:"image-list",key:u.productId},[e("div",at,[m(B,{fit:"cover",class:"lg-image",src:_(S)(u.picThumb)},null,8,["src"]),e("div",{class:"del-bb",onClick:De(O=>q(h),["stop"])},null,8,ot)])]))),128))])),e("div",null,[m(z,{onClick:w,disabled:l.value.length===0,type:"primary"},{default:V(()=>s[6]||(s[6]=[H("确定")])),_:1},8,["disabled"])])])])])}}}),rt=ee(nt,[["__scopeId","data-v-f629ce21"]]),it={class:"im-center"},lt={class:"conversation-title-m_wrap_qcEBo"},ct={key:0,class:"conversation-title-m_name_1G8ZZ"},dt={class:"name"},ut={class:"flex"},vt={key:0,class:"reconnection"},mt={class:"message-list im-message-m_container_31cB1 im-message-box"},_t={class:"im-message-item__time"},pt={key:0,class:"im-message-item__username"},gt={class:"content__outer"},ft={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ht=["src"],yt=["src"],kt={key:2,class:"zent-avatar-image",src:fe},bt={key:0,class:"im-message-item__content"},It={key:0,class:"im-message-item__content-value"},xt={key:1,class:"im-message-item__content"},Ct={class:"im-message-item__content-value"},zt={key:2,class:"im-message-item__content"},Tt={key:0,class:"im-message-item__content-value im-message-item__content-card"},wt=["href"],St={class:"im-message-item__content-card-title"},$t={class:"im-message-item__content-card-detail"},Mt={class:"im-message-item__content-card-figure"},Dt={class:"im-message-item__content-card-desc"},Nt={key:1,class:"im-message-item__content-card-link"},Et={class:"im-message-item__content-card-title"},Rt={class:"im-message-item__content-card-detail"},Bt={class:"im-message-item__content-card-figure"},Ft={class:"right-info"},Vt={class:"im-message-item__content-card-order-name"},jt={class:"im-message-item__content-card-order-info"},Ut={key:1},Ot={key:0,class:"im-message-item__read"},Lt={key:1,class:"im-message-item__unread"},Pt={key:1},Ht={class:"im-message-item notice"},qt={class:"im-message-item__content"},At={class:"im-edit-box"},Gt={key:0,class:"im-edit-box-mask"},Zt={class:"im-resizable im-right"},Kt={class:"zent-tabs zent-tabs-type__normal right-plugins-m_tabs_1oN_5"},Qt={class:"zent-tabs-nav zent-tabs-nav-type__normal"},Wt={class:"zent-tabs-nav-content"},Jt={class:"zent-tabs-scroll"},Xt={role:"tabpanel",class:"zent-tabs-panel thin-line"},Yt={class:"profile-anonymous-m_line_kvakE",style:{height:"auto"}},es={class:"zent-badge zent-badge--has-content conversation-list-item-avatar",style:{"margin-right":"16px"}},ts={class:"zent-badge-content"},ss={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},as={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},os=["src"],ns=["src"],rs={class:"wechat-from"},is={class:"name"},ls={class:"profile-anonymous-m_line_kvakE"},cs={class:"profile-anonymous-m_line_kvakE"},ds={role:"tabpanel",class:"zent-tabs-panel"},us={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},vs={class:"edit-input"},ms={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},_s={class:"edit-input"},ps={class:"action"},gs={key:1,class:"im-layout"},fs={class:"im-default-box"},hs={class:"im-default"},ys={class:"im-default-icon"},ks=Y({__name:"Message",props:{conversationId:{type:Number,default:""},currentNewMessage:{type:Object,default:()=>({})},currentConversationData:{type:Object,default:()=>({})},msgType:{type:Number,default:1},status:{type:Number,default:1},preview:{type:Boolean,default:!1}},emits:["update:conversationId","resumeConversation","_getConversationStrat"],setup(k,{expose:N,emit:M}){const d=k,I=y({}),p=y([]),b=y(!1),i=_e({conversationId:d.conversationId,sortOrder:"desc",firstId:-1}),l=y(null);let C=y(!0),D=y(0);const E=()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},q=()=>{if(B(),l.value){C.value&&(D.value=l.value.scrollTop,C.value=!1);const{scrollTop:a,scrollHeight:o,clientHeight:L}=l.value;a==0&&b.value==!1&&p.value.length>0&&(i.firstId=p.value[0].id,c())}},w=M,j=a=>{p.value.push(a),W(()=>{E()})},A=Ee(),G=()=>{me.confirm("确认重新接入会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Ie({userId:d.currentConversationData.userId,userFrom:d.currentConversationData.userFrom}).then(a=>{d.preview?A.push({path:"/im/index",query:{id:a.id}}):(i.conversationId=a.id,i.firstId=-1,p.value=[],b.value=!1,c(),w("resumeConversation",!0))}).catch(a=>{T.error(a.message)})}).catch(()=>{})},Z=async()=>{me.confirm("确认结束该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{xe({conversationId:i.conversationId}).then(a=>{s.value={},i.conversationId=-1,w("update:conversationId",-1),w("_getConversationStrat")}).catch(a=>{T.error(a.message)})})},c=async()=>{try{const a=await Ce(i);if(a.records.length==0){b.value=!0;return}p.value=[...a.records,...p.value],W(()=>{i.firstId==-1?E():setTimeout(()=>{l.value&&(l.value.scrollTop=D.value,C.value=!0)},0)})}catch(a){console.error(a)}},s=y({}),f=async()=>{try{const a=await we({conversationId:i.conversationId});s.value=a}catch(a){T.error(a.message),console.error(a)}},z=async()=>{try{const a=await ze({conversationId:s.value.id,remark:s.value.remark,summary:s.value.summary});T.success("保存成功")}catch(a){T.error(a.message)}};ve(()=>d.conversationId,a=>{a&&a!=-1&&(i.conversationId=a,i.firstId=-1,p.value=[],b.value=!1,c(),f()),Object.keys(d.currentConversationData).length>0&&(I.value={conversationId:d.currentConversationData.id,userId:d.currentConversationData.userId,shopId:d.currentConversationData.shopId})},{immediate:!0,deep:!0});const K=a=>p.value.findIndex(o=>o.id===a.id);ve(()=>d.currentNewMessage,a=>{Object.keys(a).length>0&&K(a)===-1&&(p.value.push(a),W(()=>{E()}))},{immediate:!0,deep:!0});const R=y(!1),B=()=>{d.currentConversationData.unreadMessageCount>0&&!R.value&&U(d.currentConversationData)},U=async a=>{try{R.value=!0;const o=await Te({conversationId:a.id,userId:a.userId,shopId:a.shopId});d.currentConversationData.unreadMessageCount=0}catch(o){T.error(o.message)}finally{R.value=!1}},Q=()=>{p.value.forEach(a=>{a.type===2&&a.isRead===0&&(a.isRead=1)})},u=()=>{w("update:conversationId",-1),w("_getConversationStrat")};N({_setRead:U,setReadOneself:Q});const h=y(1),O=a=>{h.value=a};return(a,o)=>{var se,ae,oe,ne,re,ie;const L=x("el-image"),te=x("TigInput"),pe=x("el-button"),ge=x("el-icon");return n(),r($,null,[i.conversationId!=-1?(n(),r("div",{key:0,class:F([k.preview?"preview-style":"","im-layout"]),onClick:B},[e("div",it,[e("div",lt,[s.value.user?(n(),r("div",ct,[e("div",dt,g((se=k.currentConversationData.user)==null?void 0:se.username),1),e("div",ut,[k.preview?v("",!0):(n(),r("div",vt,[m(Fe,{onServersUpdated:u,conversationId:i.conversationId},null,8,["conversationId"])])),e("div",{class:"reception-panel-toolbar-waiting",onClick:Z},"结束")])])):v("",!0)]),e("div",mt,[e("div",{ref_key:"messageBoxRef",ref:l,onScroll:q,class:"message-list-content"},[(n(!0),r($,null,X(p.value,(t,bs)=>{var le,ce;return n(),r($,{key:t.id},[t.type!==3?(n(),r("div",{key:0,class:F(["im-message-item text",{left:t.type===1,right:t.type===2}])},[e("div",_t,g(t.sendTime),1),t.type===2&&t.servant?(n(),r("div",pt,g(t.servant.username),1)):v("",!0),e("div",gt,[e("span",ft,[t.type===2&&t.servant.avatar?(n(),r("img",{key:0,class:"zent-avatar-image",src:_(de)(t.servant.avatar)},null,8,ht)):t.type===1&&t.user.avatar?(n(),r("img",{key:1,class:"zent-avatar-image",src:_(de)(t.user.avatar)},null,8,yt)):(n(),r("img",kt))]),t.messageType=="text"?(n(),r("div",bt,[t.content&&t.content.content?(n(),r("div",It,[m(_(He),{content:t.content.content},null,8,["content"])])):v("",!0)])):v("",!0),t.content&&t.messageType=="image"?(n(),r("div",xt,[e("div",Ct,[m(L,{style:{height:"200px"},src:_(S)((le=t.content)==null?void 0:le.pic),"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[_(S)((ce=t.content)==null?void 0:ce.pic)],"hide-on-click-modal":"",fit:"cover"},null,8,["src","preview-src-list"])])])):v("",!0),t.messageType=="custom"?(n(),r("div",zt,[t.content?(n(),r("div",Tt,[t.content.product!==null?(n(),r("a",{key:0,href:_(he)({path:"product",sn:t.content.product.productSn}),target:"_blank",class:"im-message-item__content-card-link"},[e("h4",St,g(t.content.product.productName),1),e("div",$t,[e("figure",Mt,[m(L,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:_(S)(t.content.product.picUrl?t.content.product.picUrl:t.content.product.picThumb)},null,8,["src"])]),e("p",Dt,g(_(J)(t.content.product.productPrice)),1)])],8,wt)):v("",!0),t.content.order!==null?(n(),r("a",Nt,[e("h4",Et,g(t.content.order.orderStatusName),1),e("div",Rt,[e("figure",Bt,[m(L,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:_(S)(t.content.order.picUrl?t.content.order.picUrl:t.content.order.picThumb)},null,8,["src"])]),e("div",Ft,[e("div",Vt,g(t.content.order.productName),1),e("div",jt,[e("div",null,"共"+g(t.content.order.productNum)+"件商品",1),e("div",null,"合计"+g(_(J)(t.content.order.totalAmount)),1)])])])])):v("",!0)])):v("",!0)])):v("",!0)]),t.type===2?(n(),r("div",Ut,[t.isRead?(n(),r("span",Ot,"已读")):(n(),r("span",Lt,"未读"))])):v("",!0)],2)):v("",!0),t.type===3&&t.messageType==="text"?(n(),r("div",Pt,[e("div",Ht,[e("div",qt,g(t.sendTime)+" "+g(t.content?t.content.content:""),1)])])):v("",!0)],64)}),128))],544)]),e("div",At,[k.status===2?(n(),r("div",Gt,[o[6]||(o[6]=H(" 如需联系客户，请点击 ")),e("a",{class:"zent-link",onClick:G},"开始对话")])):(n(),P(be,{key:1,messageInfo:I.value,onSendMessage:j},null,8,["messageInfo"]))])]),o[16]||(o[16]=e("div",{class:"im-resizable-anchor"},null,-1)),e("div",Zt,[e("div",Kt,[e("div",Qt,[e("div",Wt,[e("div",Jt,[e("div",{class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":h.value==1}]),onClick:o[0]||(o[0]=t=>O(1))},o[7]||(o[7]=[e("div",{class:"zent-tabs-tab-inner"},"资料",-1)]),2),e("div",{class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":h.value==2}]),onClick:o[1]||(o[1]=t=>O(2))},o[8]||(o[8]=[e("div",{class:"zent-tabs-tab-inner"},"订单",-1)]),2),k.preview?v("",!0):(n(),r("div",{key:0,class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":h.value==3}]),onClick:o[2]||(o[2]=t=>O(3))},o[9]||(o[9]=[e("div",{class:"zent-tabs-tab-inner"},"商品",-1)]),2))])])])]),e("div",null,[h.value==1?(n(),r($,{key:0},[e("div",Xt,[e("div",Yt,[e("label",null,[e("div",es,[e("div",ts,[e("span",ss,[e("span",as,[_(Re)(String((ae=s.value.user)==null?void 0:ae.avatar))=="def"?(n(),r("img",{key:0,class:"zent-avatar-image",src:_(ye)((oe=s.value.user)==null?void 0:oe.avatar)},null,8,os)):(n(),r("img",{key:1,class:"zent-avatar-image",src:_(S)((ne=s.value.user)==null?void 0:ne.avatar)},null,8,ns))])])])])]),e("div",rs,[e("div",is,g((re=s.value.user)==null?void 0:re.username),1),o[10]||(o[10]=e("div",{class:"tags"},null,-1))])]),e("div",ls,[o[11]||(o[11]=e("label",null,"昵称：",-1)),e("span",null,g((ie=s.value.user)==null?void 0:ie.nickname),1)]),e("div",cs,[o[12]||(o[12]=e("label",null,"会话来源：",-1)),e("span",null,g(s.value.userFrom),1)])]),e("div",ds,[e("div",us,[o[13]||(o[13]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话总结：",-1)),e("div",vs,[m(te,{modelValue:s.value.summary,"onUpdate:modelValue":o[3]||(o[3]=t=>s.value.summary=t)},null,8,["modelValue"])])]),e("div",ms,[o[14]||(o[14]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话备注：",-1)),e("div",_s,[m(te,{modelValue:s.value.remark,"onUpdate:modelValue":o[4]||(o[4]=t=>s.value.remark=t),rows:6,type:"textarea"},null,8,["modelValue"])])]),e("div",ps,[m(pe,{type:"primary",disabled:s.value.remark=="",onClick:o[5]||(o[5]=t=>z())},{default:V(()=>o[15]||(o[15]=[H("保存")])),_:1},8,["disabled"])])])],64)):h.value==2?(n(),P(Ue,{key:1,preview:k.preview,userId:k.currentConversationData.userId},null,8,["preview","userId"])):h.value==3?(n(),P(rt,{key:2,messageInfo:I.value,onSendMessage:j},null,8,["messageInfo"])):v("",!0)])])],2)):v("",!0),i.conversationId==-1?(n(),r("div",gs,[e("div",fs,[e("div",hs,[e("div",ys,[m(ge,{color:"#d5d5d5",size:"50"},{default:V(()=>[m(_(Be))]),_:1})]),o[17]||(o[17]=e("div",{class:"im-default-text"},[e("span",null,"没有选中会话哦")],-1))])])])):v("",!0)],64)}}}),js=ee(ks,[["__scopeId","data-v-8b5be2a9"]]);export{js as default};
