import{i as S,p as K,e as de,_ as fe,u as he,r as ye}from"./format-DFT-VJzO.js";import{s as ke,S as be,c as xe,d as Ce,a as ze,b as we,e as Ie,f as Se}from"./SendMessage-BGS9TMjM.js";import{d as Y,i as h,c as i,o,_ as ee,m as ue,G as me,u as $e,q as Me,e,b as v,w as R,f as _,F as M,j as P,a as X,r as C,g as m,I as $,E as H,D as g,M as De,P as Te,p as _e,n as N,A as J,aQ as ve,C as Ee,aN as Be,dS as Ve}from"./index-CGYuOau0.js";import je from"./Reconnection-CNMRKK1U.js";/* empty css             *//* empty css                                                                    */import{P as Ne}from"./Pagination-yOfjsBuR.js";import{u as Re}from"./config-DNllFJyR.js";import{g as Fe}from"./product-CxWf3yyB.js";import Le from"./OrderImList-jzSbhcUw.js";import{e as Ue}from"./Emoji-B7Jeb_f6.js";import"./index-BplITdIN.js";import"./index-smJsLN1o.js";import"./ReconnectionList-oL4dC9Gk.js";import"./StatusDot-YMdUi2kT.js";import"./conversation-BfOs7vot.js";import"./config-DU8_t5BN.js";import"./order-CoX6hLeE.js";import"./index-B-GURfkM.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-Bmm-M6gU.js";const Oe=["innerHTML"],Pe=Y({__name:"emojiHtml",props:{content:{type:String,default:""}},setup(k){const E=k,D=h("");D.value=d(E.content,Ue);function d(x,p){const b=new RegExp(`(${p.map(r=>r.name).join("|")})`,"g");return x.replace(/\[|\]/g,"").replace(b,r=>{const l=p.find(z=>z.name===r);return l?"<img class='emoji' src='http://oss.tigshop.com/official/emoji/"+l.id+".png'>":r})}return(x,p)=>(o(),i("div",{innerHTML:D.value},null,8,Oe))}}),He=ee(Pe,[["__scopeId","data-v-7e152687"]]),qe={class:"goods-search-container"},Ge={class:"goods-toolbar"},Ae={class:"goods-recommend-list"},Ze={class:"check-box"},Qe=["onClick"],We=["onClick"],Je={class:"name"},Ke={class:"price"},Xe={class:"goods-choosed-box"},Ye={key:0,class:"page"},et={class:"bot"},tt={key:0,class:"goods-choosed-box-left"},st={key:1,class:"goods-choosed-box-left-have"},at={class:"im"},nt=["onClick"],ot=Y({__name:"SelectImProduct",props:ue({messageInfo:{type:Object,default:{}}},{linkSelectData:{type:Array,default:[]},linkSelectDataModifiers:{}}),emits:ue(["sendMessage"],["update:linkSelectData"]),setup(k,{emit:E}){const D=k,d=h(!0),x=h(0),p=Re(),b=h([]),r=me({page:1,size:p.get("page_size"),sort_field:"",sort_order:"",keyword:""});$e(k,"linkSelectData");const l=h([]),z=async()=>{d.value=!0;try{const c=await Fe({...r});b.value=c.filter_result,b.value.forEach(s=>{s.check=l.value.some(f=>f.product_id===s.product_id)}),x.value=c.total}catch(c){$.error(c.message)}finally{d.value=!1}},T=c=>{const s=l.value.findIndex(f=>f.product_id===c.product_id);s!==-1?(l.value.splice(s,1),c.check=!1):l.value.length<3?(l.value.push(c),c.check=!0):$.error("一次最多发送三个商品")},B=c=>{if(c.check)T(c);else{const s=l.value.findIndex(f=>f.product_id===c.product_id);s!==-1&&l.value.splice(s,1)}},q=c=>{const s=l.value.splice(c,1)[0],f=b.value.findIndex(w=>w.product_id===s.product_id);f!==-1&&(b.value[f].check=!1)},I=()=>{F()},F=()=>{l.value.forEach(c=>{Z(c)})},G=Te("receiveValueFromGrandChild"),A=E,Z=async c=>{try{let s={};Object.assign(s,D.messageInfo,{content:{message_type:"custom",product:c||""}});const f=await ke(s);A("sendMessage",f.item),G(f.item),l.value=[],b.value.forEach(w=>w.check=!1)}catch(s){console.log(s)}finally{}};return Me(()=>{z()}),(c,s)=>{const f=C("el-input"),w=C("el-button"),Q=C("el-space"),V=C("el-checkbox"),j=C("el-image"),L=C("el-empty"),W=C("a-spin");return o(),i("div",qe,[e("div",Ge,[v(Q,null,{default:R(()=>[v(f,{style:{width:"190px"},modelValue:r.keyword,"onUpdate:modelValue":s[0]||(s[0]=u=>r.keyword=u),placeholder:"商品名称/货号"},null,8,["modelValue"]),v(w,{onClick:z},{default:R(()=>s[3]||(s[3]=[H("搜索")])),_:1})]),_:1})]),e("div",Ae,[d.value?_("",!0):(o(),i(M,{key:0},[x.value>0?(o(!0),i(M,{key:0},X(b.value,u=>(o(),i("div",{key:u.product_id,class:"product-item"},[e("div",Ze,[v(V,{modelValue:u.check,"onUpdate:modelValue":y=>u.check=y,onChange:y=>B(u)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),e("div",{class:"image-box",onClick:y=>T(u)},[v(j,{fit:"cover",class:"image",src:m(S)(u.pic_thumb)},null,8,["src"])],8,Qe),e("div",{class:"info-box",onClick:y=>T(u)},[e("div",Je,g(u.product_name),1),e("div",Ke,g(m(K)(u.product_price)),1)],8,We)]))),128)):(o(),P(L,{key:1,description:"暂无商品～"}))],64)),v(W,{spinning:d.value,style:{width:"100%","margin-top":"100px"}},null,8,["spinning"])]),e("div",Xe,[x.value>0?(o(),i("div",Ye,[v(m(Ne),{page:r.page,"onUpdate:page":s[1]||(s[1]=u=>r.page=u),size:r.size,"onUpdate:size":s[2]||(s[2]=u=>r.size=u),total:x.value,onCallback:z,layout:"slot, prev, next",background:!1},null,8,["page","size","total"])])):_("",!0),e("div",et,[l.value.length===0?(o(),i("div",tt,s[4]||(s[4]=[e("div",null,"尚未选择商品",-1)]))):(o(),i("div",st,[s[5]||(s[5]=e("div",null,"已选择",-1)),(o(!0),i(M,null,X(l.value,(u,y)=>(o(),i("div",{class:"image-list",key:u.product_id},[e("div",at,[v(j,{fit:"cover",class:"lg-image",src:m(S)(u.pic_thumb)},null,8,["src"]),e("div",{class:"del-bb",onClick:De(U=>q(y),["stop"])},null,8,nt)])]))),128))])),e("div",null,[v(w,{onClick:I,disabled:l.value.length===0,type:"primary"},{default:R(()=>s[6]||(s[6]=[H("确定")])),_:1},8,["disabled"])])])])])}}}),it=ee(ot,[["__scopeId","data-v-d4da416c"]]),rt={class:"im-center"},lt={class:"conversation-title-m_wrap_qcEBo"},ct={key:0,class:"conversation-title-m_name_1G8ZZ"},dt={class:"name"},ut={class:"flex"},_t={key:0,class:"reconnection"},vt={class:"message-list im-message-m_container_31cB1 im-message-box"},mt={class:"im-message-item__time"},pt={key:0,class:"im-message-item__username"},gt={class:"content__outer"},ft={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ht=["src"],yt=["src"],kt={key:2,class:"zent-avatar-image",src:fe},bt={key:0,class:"im-message-item__content"},xt={key:0,class:"im-message-item__content-value"},Ct={key:1,class:"im-message-item__content"},zt={class:"im-message-item__content-value"},wt={key:2,class:"im-message-item__content"},It={key:0,class:"im-message-item__content-value im-message-item__content-card"},St=["href"],$t={class:"im-message-item__content-card-title"},Mt={class:"im-message-item__content-card-detail"},Dt={class:"im-message-item__content-card-figure"},Tt={class:"im-message-item__content-card-desc"},Et={key:1,class:"im-message-item__content-card-link"},Bt={class:"im-message-item__content-card-title"},Vt={class:"im-message-item__content-card-detail"},jt={class:"im-message-item__content-card-figure"},Nt={class:"right-info"},Rt={class:"im-message-item__content-card-order-name"},Ft={class:"im-message-item__content-card-order-info"},Lt={key:1},Ut={key:0,class:"im-message-item__read"},Ot={key:1,class:"im-message-item__unread"},Pt={key:1},Ht={class:"im-message-item notice"},qt={class:"im-message-item__content"},Gt={class:"im-edit-box"},At={key:0,class:"im-edit-box-mask"},Zt={class:"im-resizable im-right"},Qt={class:"zent-tabs zent-tabs-type__normal right-plugins-m_tabs_1oN_5"},Wt={class:"zent-tabs-nav zent-tabs-nav-type__normal"},Jt={class:"zent-tabs-nav-content"},Kt={class:"zent-tabs-scroll"},Xt={role:"tabpanel",class:"zent-tabs-panel thin-line"},Yt={class:"profile-anonymous-m_line_kvakE",style:{height:"auto"}},es={class:"zent-badge zent-badge--has-content conversation-list-item-avatar",style:{"margin-right":"16px"}},ts={class:"zent-badge-content"},ss={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},as={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ns=["src"],os=["src"],is={class:"wechat-from"},rs={class:"name"},ls={class:"profile-anonymous-m_line_kvakE"},cs={class:"profile-anonymous-m_line_kvakE"},ds={role:"tabpanel",class:"zent-tabs-panel"},us={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},_s={class:"edit-input"},vs={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},ms={class:"edit-input"},ps={class:"action"},gs={key:1,class:"im-layout"},fs={class:"im-default-box"},hs={class:"im-default"},ys={class:"im-default-icon"},ks=Y({__name:"Message",props:{conversationId:{type:Number,default:""},currentNewMessage:{type:Object,default:()=>({})},currentConversationData:{type:Object,default:()=>({})},msgType:{type:Number,default:1},status:{type:Number,default:1},preview:{type:Boolean,default:!1}},emits:["update:conversationId","resumeConversation","_getConversationStrat"],setup(k,{expose:E,emit:D}){const d=k,x=h({}),p=h([]),b=h(!1),r=me({conversation_id:d.conversationId,sort_order:"desc",first_id:-1}),l=h(null);let z=h(!0),T=h(0);const B=()=>{l.value&&(l.value.scrollTop=l.value.scrollHeight)},q=()=>{if(j(),l.value){z.value&&(T.value=l.value.scrollTop,z.value=!1);const{scrollTop:a,scrollHeight:n,clientHeight:O}=l.value;a==0&&b.value==!1&&p.value.length>0&&(r.first_id=p.value[0].id,c())}},I=D,F=a=>{p.value.push(a),J(()=>{B()})},G=Ee(),A=()=>{ve.confirm("确认重新接入会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{xe({user_id:d.currentConversationData.user_id,user_from:d.currentConversationData.user_from}).then(a=>{d.preview?G.push({path:"/im/index",query:{id:a.item.id}}):(r.conversation_id=a.item.id,r.first_id=-1,p.value=[],b.value=!1,c(),I("resumeConversation",!0))}).catch(a=>{$.error(a.message)})}).catch(()=>{})},Z=async()=>{ve.confirm("确认结束该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Ce({conversation_id:r.conversation_id}).then(a=>{s.value={},r.conversation_id=-1,I("update:conversationId",-1),I("_getConversationStrat")}).catch(a=>{$.error(a.message)})})},c=async()=>{try{const a=await ze(r);if(a.filter_result.length==0){b.value=!0;return}p.value.unshift(...a.filter_result),J(()=>{r.first_id==-1?B():setTimeout(()=>{l.value&&(l.value.scrollTop=T.value,z.value=!0)},0)})}catch(a){console.error(a)}},s=h({}),f=async()=>{try{const a=await Se({conversation_id:r.conversation_id});s.value=a.item}catch(a){console.error(a)}},w=async()=>{try{const a=await we({conversation_id:s.value.id,remark:s.value.remark,summary:s.value.summary});$.success("保存成功")}catch(a){$.error(a.message)}};_e(()=>d.conversationId,a=>{a&&a!=-1&&(r.conversation_id=a,r.first_id=-1,p.value=[],b.value=!1,c(),f()),Object.keys(d.currentConversationData).length>0&&(x.value={conversation_id:d.currentConversationData.id,user_id:d.currentConversationData.user_id,shop_id:d.currentConversationData.shop_id})},{immediate:!0,deep:!0});const Q=a=>p.value.findIndex(n=>n.id===a.id);_e(()=>d.currentNewMessage,a=>{Object.keys(a).length>0&&Q(a)===-1&&(p.value=[...p.value,a],J(()=>{B()}))},{immediate:!0,deep:!0});const V=h(!1),j=()=>{d.currentConversationData.unread_message_count>0&&!V.value&&L(d.currentConversationData)},L=async a=>{try{V.value=!0;const n=await Ie({conversation_id:a.id,user_id:a.user_id,shop_id:a.shop_id});d.currentConversationData.unread_message_count=0}catch(n){$.error(n.message)}finally{V.value=!1}},W=()=>{p.value.forEach(a=>{a.type===2&&a.is_read===0&&(a.is_read=1)})},u=()=>{I("update:conversationId",-1),I("_getConversationStrat")};E({_setRead:L,setReadOneself:W});const y=h(1),U=a=>{y.value=a};return h([]),(a,n)=>{var se,ae,ne,oe,ie,re;const O=C("el-image"),te=C("el-input"),pe=C("el-button"),ge=C("el-icon");return o(),i(M,null,[r.conversation_id!=-1?(o(),i("div",{key:0,class:N([k.preview?"preview-style":"","im-layout"]),onClick:j},[e("div",rt,[e("div",lt,[s.value.user?(o(),i("div",ct,[e("div",dt,g((se=k.currentConversationData.user)==null?void 0:se.username),1),e("div",ut,[k.preview?_("",!0):(o(),i("div",_t,[v(je,{onServersUpdated:u,conversation_id:r.conversation_id},null,8,["conversation_id"])])),e("div",{class:"reception-panel-toolbar-waiting",onClick:Z}," 结束 ")])])):_("",!0)]),e("div",vt,[e("div",{ref_key:"messageBoxRef",ref:l,onScroll:q,class:"message-list-content"},[(o(!0),i(M,null,X(p.value,(t,bs)=>{var le,ce;return o(),i(M,null,[t.type!==3?(o(),i("div",{key:0,class:N(["im-message-item text",{left:t.type===1,right:t.type===2}])},[e("div",mt,g(t.send_time),1),t.type===2&&t.servant?(o(),i("div",pt,g(t.servant.username),1)):_("",!0),e("div",gt,[e("span",ft,[t.type===2&&t.servant.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:m(de)(t.servant.avatar)},null,8,ht)):t.type===1&&t.user.avatar?(o(),i("img",{key:1,class:"zent-avatar-image",src:m(de)(t.user.avatar)},null,8,yt)):(o(),i("img",kt))]),t.message_type=="text"?(o(),i("div",bt,[t.content&&t.content.content?(o(),i("div",xt,[v(m(He),{content:t.content.content},null,8,["content"])])):_("",!0)])):_("",!0),t.content&&t.message_type=="image"?(o(),i("div",Ct,[e("div",zt,[v(O,{style:{height:"200px"},src:m(S)((le=t.content)==null?void 0:le.pic),"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[m(S)((ce=t.content)==null?void 0:ce.pic)],"hide-on-click-modal":"",fit:"cover"},null,8,["src","preview-src-list"])])])):_("",!0),t.message_type=="custom"?(o(),i("div",wt,[t.content?(o(),i("div",It,[t.content.product!==null?(o(),i("a",{key:0,href:m(he)({path:"product",sn:t.content.product.product_sn}),target:"_blank",class:"im-message-item__content-card-link"},[e("h4",$t,g(t.content.product.product_name),1),e("div",Mt,[e("figure",Dt,[v(O,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:m(S)(t.content.product.pic_url?t.content.product.pic_url:t.content.product.pic_thumb)},null,8,["src"])]),e("p",Tt,g(m(K)(t.content.product.product_price)),1)])],8,St)):_("",!0),t.content.order!==null?(o(),i("a",Et,[e("h4",Bt,g(t.content.order.order_status_name),1),e("div",Vt,[e("figure",jt,[v(O,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:m(S)(t.content.order.pic_url?t.content.order.pic_url:t.content.order.pic_thumb)},null,8,["src"])]),e("div",Nt,[e("div",Rt,g(t.content.order.product_name),1),e("div",Ft,[e("div",null,"共"+g(t.content.order.product_num)+"件商品",1),e("div",null,"合计"+g(m(K)(t.content.order.total_amount)),1)])])])])):_("",!0)])):_("",!0)])):_("",!0)]),t.type===2?(o(),i("div",Lt,[t.is_read?(o(),i("span",Ut,"已读")):(o(),i("span",Ot,"未读"))])):_("",!0)],2)):_("",!0),t.type===3&&t.message_type==="text"?(o(),i("div",Pt,[e("div",Ht,[e("div",qt,g(t.send_time)+" "+g(t.content?t.content.content:""),1)])])):_("",!0)],64)}),256))],544)]),e("div",Gt,[k.status===2?(o(),i("div",At,[n[6]||(n[6]=H(" 如需联系客户，请点击 ")),e("a",{class:"zent-link",onClick:A},"开始对话")])):(o(),P(be,{key:1,messageInfo:x.value,onSendMessage:F},null,8,["messageInfo"]))])]),n[16]||(n[16]=e("div",{class:"im-resizable-anchor"},null,-1)),e("div",Zt,[e("div",Qt,[e("div",Wt,[e("div",Jt,[e("div",Kt,[e("div",{class:N(["zent-tabs-tab",{"zent-tabs-tab__actived":y.value==1}]),onClick:n[0]||(n[0]=t=>U(1))},n[7]||(n[7]=[e("div",{class:"zent-tabs-tab-inner"},"资料",-1)]),2),e("div",{class:N(["zent-tabs-tab",{"zent-tabs-tab__actived":y.value==2}]),onClick:n[1]||(n[1]=t=>U(2))},n[8]||(n[8]=[e("div",{class:"zent-tabs-tab-inner"},"订单",-1)]),2),k.preview?_("",!0):(o(),i("div",{key:0,class:N(["zent-tabs-tab",{"zent-tabs-tab__actived":y.value==3}]),onClick:n[2]||(n[2]=t=>U(3))},n[9]||(n[9]=[e("div",{class:"zent-tabs-tab-inner"},"商品",-1)]),2))])])])]),e("div",null,[y.value==1?(o(),i(M,{key:0},[e("div",Xt,[e("div",Yt,[e("label",null,[e("div",es,[e("div",ts,[e("span",ss,[e("span",as,[m(Be)(String((ae=s.value.user)==null?void 0:ae.avatar))=="def"?(o(),i("img",{key:0,class:"zent-avatar-image",src:m(ye)((ne=s.value.user)==null?void 0:ne.avatar)},null,8,ns)):(o(),i("img",{key:1,class:"zent-avatar-image",src:m(S)((oe=s.value.user)==null?void 0:oe.avatar)},null,8,os))])])])])]),e("div",is,[e("div",rs,g((ie=s.value.user)==null?void 0:ie.username),1),n[10]||(n[10]=e("div",{class:"tags"},null,-1))])]),e("div",ls,[n[11]||(n[11]=e("label",null,"昵称：",-1)),e("span",null,g((re=s.value.user)==null?void 0:re.nickname),1)]),e("div",cs,[n[12]||(n[12]=e("label",null,"会话来源：",-1)),e("span",null,g(s.value.user_from),1)])]),e("div",ds,[e("div",us,[n[13]||(n[13]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话总结：",-1)),e("div",_s,[v(te,{modelValue:s.value.summary,"onUpdate:modelValue":n[3]||(n[3]=t=>s.value.summary=t)},null,8,["modelValue"])])]),e("div",vs,[n[14]||(n[14]=e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话备注：",-1)),e("div",ms,[v(te,{modelValue:s.value.remark,"onUpdate:modelValue":n[4]||(n[4]=t=>s.value.remark=t),rows:6,type:"textarea"},null,8,["modelValue"])])]),e("div",ps,[v(pe,{type:"primary",disabled:s.value.remark=="",onClick:n[5]||(n[5]=t=>w())},{default:R(()=>n[15]||(n[15]=[H("保存")])),_:1},8,["disabled"])])])],64)):y.value==2?(o(),P(Le,{key:1,preview:k.preview,userId:k.currentConversationData.user_id},null,8,["preview","userId"])):y.value==3?(o(),P(it,{key:2,messageInfo:x.value,onSendMessage:F},null,8,["messageInfo"])):_("",!0)])])],2)):_("",!0),r.conversation_id==-1?(o(),i("div",gs,[e("div",fs,[e("div",hs,[e("div",ys,[v(ge,{color:"#d5d5d5",size:"50"},{default:R(()=>[v(m(Ve))]),_:1})]),n[17]||(n[17]=e("div",{class:"im-default-text"},[e("span",null,"没有选中会话哦")],-1))])])])):_("",!0)],64)}}}),Ps=ee(ks,[["__scopeId","data-v-66372b68"]]);export{Ps as default};
