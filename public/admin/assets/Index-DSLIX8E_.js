import{d as Le,i as l,C as We,q as Ne,c as i,e,b as d,j as G,f as b,a3 as H,dd as $e,a4 as Y,w,N as de,D as c,F as T,a as O,n as B,l as ve,I as L,A as Ae,r as W,e3 as Fe,o,g as y,e4 as ue,E as he,aT as Re,J as He,_ as Oe}from"./index-DrbzVNl6.js";import{f as V,_ as D}from"./format-CRgx78oe.js";import Be from"./Message-Cdz6uY_5.js";import{g as _e,d as Ve}from"./SendMessage-BMjrCabi.js";import De from"./CurrentQueueNumber-DW95-WSx.js";import{s as Pe,g as Ue,a as Je}from"./conversation-rd7RS6Jg.js";import"./Verify.vue_vue_type_style_index_0_lang-B5aTvMR3.js";import"./zh-cn-W45FenWv.js";import{_ as j}from"./QueueList-B9ftwLiD.js";import{u as Qe}from"./im-DWn2qVSQ.js";import qe from"./promptTone-DRpmMGmX.js";import"./Reconnection-BJKzo9EH.js";import"./ReconnectionList-Rejb_FPF.js";import"./StatusDot-eKxl7wC-.js";/* empty css             *//* empty css                                                                    */import"./Pagination-wR9huHyl.js";import"./product-DEi2MlvQ.js";import"./OrderImList-T8ZRrNJY.js";import"./order-DqMQuu0g.js";import"./index-CeQDmMxd.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-DqYSRv0_.js";import"./Emoji-DFvwznDF.js";import"./DeleteRecord-MR4vGqLl.js";import"./brand-C64i7ZtK.js";const N=class N{log(a,g){N.console}closeConsole(){N.console=!1}};N.console=!0;let K=N;class Ge extends K{constructor(){super(...arguments),this.listeners={}}addEventListener(a,g){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].indexOf(g)===-1&&this.listeners[a].push(g)}removeEventListener(a){this.listeners[a]=[]}dispatchEvent(a,g){const x=this.listeners[a]||[];x.length!==0&&x.forEach(v=>{v.call(this,g)})}}class Ye extends Ge{constructor(a){super(),this.url="",this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=1e3,this.heartbeatInterval=1e3*15,this.stopWs=!1,this.url=a}onopen(a){this.addEventListener("open",a)}onmessage(a){this.addEventListener("message",a)}onclose(a){this.addEventListener("close",a)}onerror(a){this.addEventListener("error",a)}send(a){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(a):console.error("[WebSocket] 未连接")}connect(){this.reconnectAttempts===0&&this.log("WebSocket",`初始化连接中...          ${this.url}`),!(this.socket&&this.socket.readyState===WebSocket.OPEN)&&(this.socket=new WebSocket(this.url),this.socket.onopen=a=>{this.stopWs=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.log("WebSocket",`连接成功,等待服务端数据推送[onopen]...     ${this.url}`),this.dispatchEvent("open",a)},this.socket.onmessage=a=>{this.dispatchEvent("message",a),this.startHeartbeat()},this.socket.onclose=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接断开[onclose]...    ${this.url}`),this.stopWs||this.handleReconnect(),this.dispatchEvent("close",a)},this.socket.onerror=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接异常[onerror]...    ${this.url}`),this.closeHeartbeat(),this.dispatchEvent("error",a)})}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.log("WebSocket",`尝试重连... (${this.reconnectAttempts}/${this.maxReconnectAttempts})       ${this.url}`),setTimeout(()=>{this.connect()},this.reconnectInterval)):(this.closeHeartbeat(),this.log("WebSocket",`最大重连失败，终止重连: ${this.url}`))}close(){this.socket&&(this.stopWs=!0,this.socket.close(),this.socket=null,this.removeEventListener("open"),this.removeEventListener("message"),this.removeEventListener("close"),this.removeEventListener("error")),this.closeHeartbeat()}startHeartbeat(){this.stopWs||(this.heartbeatTimer&&this.closeHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.socket?(this.socket.send(JSON.stringify({type:"heartBeat",data:{}})),this.log("WebSocket","送心跳数据...")):console.error("[WebSocket] 未连接")},this.heartbeatInterval))}closeHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}}const je={class:"app-layout-m_content_wYOV9"},Ke={class:"im"},Xe={class:"im-resizable im-left reception-panel im-resizable-right"},Ze={class:"reception-panel-search"},et={class:"super-search-box-module_wrap_i3xn3 reception-panel-search-searcher"},tt={class:"super-search-box-module_search_2qwmN"},st={class:"super-search-box-module_icon_1LUOA"},nt={class:"conversation-list-item-del"},ot={class:"reception-panel-mask"},at={class:"reception-filter-content"},it={key:0,class:"reception-filter-list"},rt={class:"reception-filter-item-title"},ct=["onClick"],lt={class:"reception-filter-item-head"},dt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},vt=["src"],ut={key:1,class:"zent-avatar-image",src:D},ht={class:"reception-filter-item-body"},_t={class:"reception-filter-item-name"},mt={class:"name"},pt={class:"label text-transform"},gt={key:1,class:"reception-filter-list"},ft={class:"reception-filter-item-title"},bt=["onClick"],yt={class:"reception-filter-item-head"},kt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},zt=["src"],Ct={key:1,class:"zent-avatar-image",src:D},wt={class:"reception-filter-item-body"},xt={class:"reception-filter-item-name"},It={class:"name"},St={class:"label text-transform"},Mt={class:"reception-filter-item-desc"},Et={class:"desc"},Tt={class:"time"},Lt={class:"reception-panel-wrap"},Wt={class:"zent-tabs zent-tabs-type__normal reception-panel-tabs Panel-m_reception-panel-tabs_82Sn7"},Nt={class:"zent-tabs-nav zent-tabs-nav-type__normal zent-tabs-nav__stretch"},$t={class:"zent-tabs-nav-content"},At={class:"zent-tabs-scroll",role:"tablist"},Ft={class:"zent-tabs-tab-inner"},Rt={class:"zent-tabs-tab-inner"},Ht={class:"reception-panel-toolbar"},Ot={class:"flex flex-justify-between"},Bt={class:"reception-panel-toolbar-waiting-count"},Vt={class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},Dt={class:"conversation-list"},Pt={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},Ut=["onClick"],Jt={class:"conversation-list-item-mark"},Qt={class:"zent-tooltip-wrapper"},qt={class:""},Gt={class:"conversation-list-item-del"},Yt={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},jt={class:"zent-badge-content"},Kt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},Xt=["src"],Zt={key:1,class:"zent-avatar-image",src:D},es={key:0,class:"zent-badge-count"},ts={class:"conversation-list-item-content"},ss={class:"conversation-list-item-line"},ns={class:"conversation-list-item-name"},os={class:"conversation-list-item-tag"},as={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},is={class:"zent-tag-content text-transform"},rs={class:"conversation-list-item-line"},cs={key:0,class:"conversation-list-item-message"},ls={key:0},ds=["innerHTML"],vs={key:1},us={class:"conversation-list-item-timestamp"},hs={key:1,class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},_s={class:"conversation-list reception-panel-finished-list"},ms={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},ps=["onClick"],gs={class:"conversation-list-item-mark"},fs={class:"zent-tooltip-wrapper"},bs={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},ys={class:"zent-badge-content"},ks={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},zs=["src"],Cs={key:1,class:"zent-avatar-image",src:D},ws={key:0,class:"zent-badge-count"},xs={class:"conversation-list-item-content"},Is={class:"conversation-list-item-line"},Ss={class:"conversation-list-item-name"},Ms={class:"conversation-list-item-tag"},Es={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},Ts={class:"zent-tag-content text-transform"},Ls={class:"conversation-list-item-line"},Ws={key:0,class:"conversation-list-item-message"},Ns={class:"conversation-list-item-timestamp"},$s=Le({__name:"Index",emits:["update:isEditComment","successAdded","sendMessage"],setup(X,{emit:a}){const g=l(),x=l(),v=l(-1),z=l(1),P=l(!1),$=l(!1),A=t=>{z.value=t,t===1&&(S("tab"),P.value=!1),t===2&&(Q("tab"),$.value=!1)},f=l(""),F=l(!1),U=l(null),h=l({conversationList:[],userList:[]}),me=()=>{F.value=!0},pe=()=>{f.value==""&&h.value.conversationList.length==0&&h.value.userList.length==0&&(F.value=!1)},ge=()=>{f.value="",h.value={conversationList:[],userList:[]},U.value.focus()},fe=async t=>{if(U.value.focus(),f.value!="")try{const s=await Je({keyword:f.value});h.value=s,console.log(h.value)}catch(s){L.error(s.message)}finally{}},Z=l({}),C=l({}),I=(t,s)=>{var r;t!=-1?(C.value=t,v.value=t.id,t.unreadMessageCount>0&&(t.unreadMessageCount=0,(r=g.value)==null||r._setRead(t))):v.value=-1},be=async t=>{console.log(t),Re.confirm("确认删除该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Ve({conversationId:t.id}).then(s=>{C.value="",v.value=-1,S()}).catch(s=>{L.error(s.message)})})},ye=t=>{t&&(C.value.status=1,A(2),A(1))},u=l([]),J=l([]),k=l(!1),S=async t=>{try{k.value=!0,console.log("====");const s=await _e({status:1});u.value=s.records,t!=="tab"&&s.records.forEach(r=>{Number(r.unreadMessageCount)>0&&(P.value=!0)})}catch(s){L.error(s.message)}finally{k.value=!1}},Q=async t=>{try{k.value=!0;const s=await _e({status:2});J.value=s.records,console.log($.value),t!=="tab"&&s.records.forEach(r=>{Number(r.unreadMessageCount)>0&&($.value=!0)})}catch(s){L.error(s.message)}finally{k.value=!1}},ke=async()=>{await S(),await Q()},ze=t=>{},Ce=t=>{var r;const s=u.value.findIndex(R=>R.id===t.conversationId);v.value>-1?(console.log("当前会话",v.value,t.conversationId),t.conversationId===v.value?(Z.value=t,t.content.contentCategory==="end_conversation"&&(C.value.status=2)):s===-1&&ee(t),u.value[s].lastMessage[0]=t,u.value[s].unreadMessageCount++):s>-1?(u.value[s].lastMessage[0]=t,u.value[s].unreadMessageCount++):ee(t),t.content.contentCategory==="end_conversation"&&(u.value[s].status=2),(r=x.value)==null||r.play()},ee=t=>{const s={id:t.conversationId,shopId:t.shopId,userId:t.userId,lastMessage:[t],unreadMessageCount:1,user:t.user,userFrom:t.userFrom};u.value=[s,...u.value],console.log("创建会话",s)},we=t=>{var r;if(!Fe(t.data)){console.error("收到非JSON格式数据");return}const s=JSON.parse(t.data);s.type==="message"&&(console.log("message",s),s.data&&Ce(s.data[0])),s.type==="read"&&(console.log("read",s),s.data[0].shopId===C.value.shopId&&((r=g.value)==null||r.setReadOneself()))},xe=t=>{},Ie=t=>{},Se=()=>{let t;return console.log(import.meta),t=location.origin?location.origin.replace(/^http:/,"ws:").replace(/^https:/,"wss:")+"/ws":"",t};(()=>{const t=new Ye(`${Se()}?token=${localStorage.getItem("accessToken")}&platform=admin`);t.onclose(xe),t.onopen(ze),t.onerror(Ie),t.onmessage(we),t.connect()})();const q=l(0),te=l(null),Me=async()=>{try{const t=Qe(),s=await Pe({status:1});t.setImPresence(1);const r=await Ue({page:1});q.value=r.total,q.value>0&&Ae(()=>{te.value.showWin()})}catch(t){L.error(t.message)}finally{}};He("receiveValueFromGrandChild",t=>{console.log("receiveValueFromGrandChild",t),u.value.map(s=>{s.id===t.conversationId&&(s.lastMessage=[t])})});const se=We().currentRoute.value.query;return Ne(async()=>{if(await Me(),await S(),await Q(),se.id){const t=u.value.find(s=>s.id===parseInt(se.id));t&&await I(t)}}),(t,s)=>{var ae,ie;const r=W("SvgIcon"),R=W("el-icon"),Ee=W("el-button"),ne=W("el-badge"),oe=W("a-spin");return o(),i("div",je,[e("div",Ke,[e("div",Xe,[e("div",Ze,[e("div",et,[e("div",tt,[e("span",st,[d(r,{name:"im-search",width:"16",height:"16"})]),H(e("input",{ref_key:"searchInput",ref:U,"onUpdate:modelValue":s[0]||(s[0]=n=>f.value=n),onFocus:me,onBlur:pe,class:"super-search-box-module_input_3HdzN",placeholder:"搜索最近联系人、聊天记录"},null,544),[[$e,f.value]]),H(e("div",nt,[d(R,{onClick:de(ge,["stop","prevent"]),size:"13",color:"#797979"},{default:w(()=>[d(y(ue))]),_:1})],512),[[Y,f.value!=""]])]),H(d(Ee,{class:"super-search-btn",type:"primary",size:"mini",onClick:fe},{default:w(()=>s[4]||(s[4]=[he("搜索")])),_:1},512),[[Y,F.value&&f.value!=""]])])]),H(e("div",ot,[e("div",at,[h.value.userList.length>0?(o(),i("div",it,[e("div",rt,"联系人("+c(((ae=h.value.userList)==null?void 0:ae.length)||0)+")",1),(o(!0),i(T,null,O(h.value.userList,(n,M)=>{var _,m,p;return o(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:E=>I(n)},[e("div",lt,[e("span",dt,[(_=n.user)!=null&&_.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,vt)):(o(),i("img",ut))])]),e("div",ht,[e("div",_t,[e("div",mt,c((p=n.user)==null?void 0:p.username),1),e("div",pt,c(n.userFrom),1)])])],8,ct)}),128))])):b("",!0),h.value.conversationList.length>0?(o(),i("div",gt,[e("div",ft,"聊天记录("+c(((ie=h.value.conversationList)==null?void 0:ie.length)||0)+")",1),(o(!0),i(T,null,O(h.value.conversationList,(n,M)=>{var _,m,p;return o(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:E=>I(n)},[e("div",yt,[e("span",kt,[(_=n.user)!=null&&_.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,zt)):(o(),i("img",Ct))])]),e("div",wt,[e("div",xt,[e("div",It,c((p=n.user)==null?void 0:p.username),1),e("div",St,c(n.userFrom),1)]),e("div",Mt,[e("div",Et,c(f.value),1),e("div",Tt,[d(y(j),{time:n.addTime},null,8,["time"])])])])],8,bt)}),128))])):b("",!0)])],512),[[Y,F.value]]),e("div",Lt,[e("div",Wt,[e("div",Nt,[e("div",$t,[e("div",At,[e("div",{class:B(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":z.value===1}]),onClick:s[1]||(s[1]=n=>A(1))},[d(ne,{"is-dot":"",offset:[-80,15],color:P.value?"#f33":"#fff"},{default:w(()=>[e("div",Ft,"会话中("+c(u.value.length)+")",1)]),_:1},8,["color"])],2),e("div",{class:B(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":z.value===2}]),onClick:s[2]||(s[2]=n=>A(2))},[d(ne,{"is-dot":"",offset:[-80,15],color:$.value?"#f33":"#fff"},{default:w(()=>[e("div",Rt,"已结束("+c(J.value.length)+")",1)]),_:1},8,["color"])],2)])])])]),z.value===1?(o(),i(T,{key:0},[e("div",Ht,[d(De,{ref_key:"CurrentQueueNumbererRef",ref:te,onClose:ke,style:{width:"100%"}},{default:w(()=>[e("div",Ot,[e("div",null,[s[5]||(s[5]=he(" 待接入数量：")),e("span",Bt,c(q.value),1)]),d(r,{class:"zenticon zenticon-right",name:"im-arrow",width:"12",height:"12"})])]),_:1},512)]),e("div",Vt,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",Dt,[k.value?(o(),G(oe,{key:1,spinning:k.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(o(),i("div",Pt,[(o(!0),i(T,null,O(u.value,(n,M)=>{var _,m,p,E,re,ce,le;return o(),i("div",{class:B(["conversation-list-item",{"conversation-list-item-active":v.value==n.id}]),onClick:Te=>I(n)},[e("div",Jt,[e("div",Qt,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",qt,[e("div",Gt,[d(R,{onClick:de(Te=>be(n),["stop","prevent"]),size:"20",color:"#bbbbbb"},{default:w(()=>[d(y(ue))]),_:2},1032,["onClick"])])]),e("div",Yt,[e("div",jt,[e("span",Kt,[(_=n.user)!=null&&_.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,Xt)):(o(),i("img",Zt))]),n.unreadMessageCount>0?(o(),i("span",es,c(n.unreadMessageCount),1)):b("",!0)])]),e("div",ts,[e("div",ss,[e("div",ns,c(n.user?n.user.username:""),1),e("div",os,[e("div",as,[e("div",is,c(n.userFrom),1)])])]),e("div",rs,[n.lastMessage?(o(),i("div",cs,[((p=n.lastMessage[0])==null?void 0:p.messageType)=="text"?(o(),i("div",ls,[e("div",{class:"conversation-list-item-message-text",innerHTML:(re=(E=n.lastMessage[0])==null?void 0:E.content)==null?void 0:re.content},null,8,ds)])):(o(),i("div",vs,c((ce=n.lastMessage[0])==null?void 0:ce.messageTypeText),1))])):b("",!0),e("div",us,[d(y(j),{time:(le=n.lastMessage[0])==null?void 0:le.sendTime},null,8,["time"])])])])],10,Ut)}),256))]))])])])],64)):b("",!0),z.value===2?(o(),i("div",hs,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",_s,[k.value?(o(),G(oe,{key:1,spinning:k.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(o(),i("div",ms,[(o(!0),i(T,null,O(J.value,(n,M)=>{var _,m,p;return o(),i("div",{class:B(["conversation-list-item",{"conversation-list-item-active":v.value==n.id}]),onClick:E=>I(n,z.value)},[e("div",gs,[e("div",fs,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",bs,[e("div",ys,[e("span",ks,[(_=n.user)!=null&&_.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,zs)):(o(),i("img",Cs))]),n.unreadMessageCount>0?(o(),i("span",ws,c(n.unreadMessageCount),1)):b("",!0)])]),e("div",xs,[e("div",Is,[e("div",Ss,c(n.user?n.user.username:""),1),e("div",Ms,[e("div",Es,[e("div",Ts,c(n.userFrom),1)])])]),e("div",Ls,[n.lastMessage?(o(),i("div",Ws,c(((p=n.lastMessage[0].content)==null?void 0:p.content)||n.lastMessage[0].messageTypeText),1)):b("",!0),e("div",Ns,[d(y(j),{time:n.addTime},null,8,["time"])])])])],10,ps)}),256))]))])])])):b("",!0)])]),s[6]||(s[6]=e("div",{class:"im-resizable-anchor"},null,-1)),v.value?(o(),G(Be,{key:0,ref_key:"ImMessageRef",ref:g,conversationId:v.value,"onUpdate:conversationId":s[3]||(s[3]=n=>v.value=n),currentNewMessage:Z.value,currentConversationData:C.value,msgType:z.value,onResumeConversation:ye,on_getConversationStrat:S},null,8,["conversationId","currentNewMessage","currentConversationData","msgType"])):b("",!0)]),d(qe,{ref_key:"promptToneRef",ref:x},null,512)])}}}),ln=Oe($s,[["__scopeId","data-v-3c3b4c65"]]);export{ln as default};
