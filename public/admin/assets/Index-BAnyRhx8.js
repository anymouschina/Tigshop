import{d as $e,i as l,C as We,q as Te,c as i,e,b as d,j as J,f as k,a0 as B,d2 as Ne,a1 as Y,w as C,M as de,D as c,F as L,a as F,n as O,l as ve,I as $,A as Re,r as W,o,g as y,dR as ue,E as _e,aQ as Ae,J as He,_ as Be}from"./index-CGYuOau0.js";import{e as V,_ as D}from"./format-DFT-VJzO.js";import Fe from"./Message-xeN4mcpG.js";import{g as he,d as Oe}from"./SendMessage-BGS9TMjM.js";import Ve from"./CurrentQueueNumber-bRgPgvps.js";import{s as De,g as Pe,a as Qe}from"./conversation-BfOs7vot.js";/* empty css                                               */import"./zh-cn-BAb8a1B9.js";import{_ as j}from"./QueueList-DAoqbpQl.js";import{u as Ue}from"./im-gvP_5d7J.js";import qe from"./promptTone-dhTrZgg1.js";import"./config-DNllFJyR.js";import"./config-DU8_t5BN.js";import"./Reconnection-CNMRKK1U.js";import"./ReconnectionList-oL4dC9Gk.js";import"./StatusDot-YMdUi2kT.js";/* empty css             *//* empty css                                                                    */import"./Pagination-yOfjsBuR.js";import"./product-CxWf3yyB.js";import"./OrderImList-jzSbhcUw.js";import"./order-CoX6hLeE.js";import"./index-B-GURfkM.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-Bmm-M6gU.js";import"./Emoji-B7Jeb_f6.js";import"./index-BplITdIN.js";import"./index-smJsLN1o.js";import"./DeleteRecord.vue_vue_type_script_setup_true_lang-BTFcBk5t.js";import"./brand-BWQ0xslz.js";const T=class T{log(a,g){if(!T.console)return;const f="#ff4d4f";console.log(`%c ${a} %c ${g} %c`,`background:${f};border:1px solid ${f}; padding: 1px; border-radius: 2px 0 0 2px; color: #fff;`,`border:1px solid ${f}; padding: 1px; border-radius: 0 2px 2px 0; color: ${f};`,"background:transparent")}closeConsole(){T.console=!1}};T.console=!0;let K=T;class Ge extends K{constructor(){super(...arguments),this.listeners={}}addEventListener(a,g){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].indexOf(g)===-1&&this.listeners[a].push(g)}removeEventListener(a){this.listeners[a]=[]}dispatchEvent(a,g){const f=this.listeners[a]||[];f.length!==0&&f.forEach(u=>{u.call(this,g)})}}class Je extends Ge{constructor(a){super(),this.url="",this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=1e3,this.heartbeatInterval=1e3*15,this.stopWs=!1,this.url=a}onopen(a){this.addEventListener("open",a)}onmessage(a){this.addEventListener("message",a)}onclose(a){this.addEventListener("close",a)}onerror(a){this.addEventListener("error",a)}send(a){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(a):console.error("[WebSocket] 未连接")}connect(){this.reconnectAttempts===0&&this.log("WebSocket",`初始化连接中...          ${this.url}`),!(this.socket&&this.socket.readyState===WebSocket.OPEN)&&(this.socket=new WebSocket(this.url),this.socket.onopen=a=>{this.stopWs=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.log("WebSocket",`连接成功,等待服务端数据推送[onopen]...     ${this.url}`),this.dispatchEvent("open",a)},this.socket.onmessage=a=>{this.dispatchEvent("message",a),this.startHeartbeat()},this.socket.onclose=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接断开[onclose]...    ${this.url}`),this.stopWs||this.handleReconnect(),this.dispatchEvent("close",a)},this.socket.onerror=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接异常[onerror]...    ${this.url}`),this.closeHeartbeat(),this.dispatchEvent("error",a)})}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.log("WebSocket",`尝试重连... (${this.reconnectAttempts}/${this.maxReconnectAttempts})       ${this.url}`),setTimeout(()=>{this.connect()},this.reconnectInterval)):(this.closeHeartbeat(),this.log("WebSocket",`最大重连失败，终止重连: ${this.url}`))}close(){this.socket&&(this.stopWs=!0,this.socket.close(),this.socket=null,this.removeEventListener("open"),this.removeEventListener("message"),this.removeEventListener("close"),this.removeEventListener("error")),this.closeHeartbeat()}startHeartbeat(){this.stopWs||(this.heartbeatTimer&&this.closeHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.socket?(this.socket.send(JSON.stringify({type:"heartBeat",data:{}})),this.log("WebSocket","送心跳数据...")):console.error("[WebSocket] 未连接")},this.heartbeatInterval))}closeHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}}const Ye={class:"app-layout-m_content_wYOV9"},je={class:"im"},Ke={class:"im-resizable im-left reception-panel im-resizable-right"},Xe={class:"reception-panel-search"},Ze={class:"super-search-box-module_wrap_i3xn3 reception-panel-search-searcher"},et={class:"super-search-box-module_search_2qwmN"},tt={class:"super-search-box-module_icon_1LUOA"},st={class:"conversation-list-item-del"},nt={class:"reception-panel-mask"},ot={class:"reception-filter-content"},at={key:0,class:"reception-filter-list"},it={class:"reception-filter-item-title"},rt=["onClick"],ct={class:"reception-filter-item-head"},lt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},dt=["src"],vt={key:1,class:"zent-avatar-image",src:D},ut={class:"reception-filter-item-body"},_t={class:"reception-filter-item-name"},ht={class:"name"},mt={class:"label text-transform"},pt={key:1,class:"reception-filter-list"},gt={class:"reception-filter-item-title"},ft=["onClick"],bt={class:"reception-filter-item-head"},kt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},yt=["src"],zt={key:1,class:"zent-avatar-image",src:D},xt={class:"reception-filter-item-body"},wt={class:"reception-filter-item-name"},Ct={class:"name"},St={class:"label text-transform"},Et={class:"reception-filter-item-desc"},It={class:"desc"},Mt={class:"time"},Lt={class:"reception-panel-wrap"},$t={class:"zent-tabs zent-tabs-type__normal reception-panel-tabs Panel-m_reception-panel-tabs_82Sn7"},Wt={class:"zent-tabs-nav zent-tabs-nav-type__normal zent-tabs-nav__stretch"},Tt={class:"zent-tabs-nav-content"},Nt={class:"zent-tabs-scroll",role:"tablist"},Rt={class:"zent-tabs-tab-inner"},At={class:"zent-tabs-tab-inner"},Ht={class:"reception-panel-toolbar"},Bt={class:"flex flex-justify-between"},Ft={class:"reception-panel-toolbar-waiting-count"},Ot={class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},Vt={class:"conversation-list"},Dt={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},Pt=["onClick"],Qt={class:"conversation-list-item-mark"},Ut={class:"zent-tooltip-wrapper"},qt={class:""},Gt={class:"conversation-list-item-del"},Jt={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},Yt={class:"zent-badge-content"},jt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},Kt=["src"],Xt={key:1,class:"zent-avatar-image",src:D},Zt={key:0,class:"zent-badge-count"},es={class:"conversation-list-item-content"},ts={class:"conversation-list-item-line"},ss={class:"conversation-list-item-name"},ns={class:"conversation-list-item-tag"},os={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},as={class:"zent-tag-content text-transform"},is={class:"conversation-list-item-line"},rs={key:0,class:"conversation-list-item-message"},cs={key:0},ls=["innerHTML"],ds={key:1},vs={class:"conversation-list-item-timestamp"},us={key:1,class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},_s={class:"conversation-list reception-panel-finished-list"},hs={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},ms=["onClick"],ps={class:"conversation-list-item-mark"},gs={class:"zent-tooltip-wrapper"},fs={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},bs={class:"zent-badge-content"},ks={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ys=["src"],zs={key:1,class:"zent-avatar-image",src:D},xs={key:0,class:"zent-badge-count"},ws={class:"conversation-list-item-content"},Cs={class:"conversation-list-item-line"},Ss={class:"conversation-list-item-name"},Es={class:"conversation-list-item-tag"},Is={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},Ms={class:"zent-tag-content text-transform"},Ls={class:"conversation-list-item-line"},$s={key:0,class:"conversation-list-item-message"},Ws={class:"conversation-list-item-timestamp"},Ts=$e({__name:"Index",emits:["update:isEditComment","successAdded","sendMessage"],setup(X,{emit:a}){const g=l(),f=l(),u=l(-1),x=l(1),P=l(!1),N=l(!1),R=t=>{x.value=t,t===1&&(E("tab"),P.value=!1),t===2&&(q("tab"),N.value=!1)},b=l(""),A=l(!1),Q=l(null),_=l({conversationList:[],userList:[]}),me=()=>{A.value=!0},pe=()=>{b.value==""&&_.value.conversationList.length==0&&_.value.userList.length==0&&(A.value=!1)},ge=()=>{b.value="",_.value={conversationList:[],userList:[]},Q.value.focus()},fe=async t=>{if(Q.value.focus(),b.value!="")try{const s=await Qe({keyword:b.value});_.value=s.item,console.log(_.value)}catch(s){$.error(s.message)}finally{}},Z=l({}),w=l({}),S=(t,s)=>{var r;t!=-1?(w.value=t,u.value=t.id,t.unread_message_count>0&&(t.unread_message_count=0,(r=g.value)==null||r._setRead(t))):u.value=-1},be=async t=>{console.log(t),Ae.confirm("确认删除该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Oe({conversation_id:t.id}).then(s=>{w.value="",u.value=-1,E()}).catch(s=>{$.error(s.message)})})},ke=t=>{t&&(w.value.status=1,R(2),R(1))},v=l([]),U=l([]),z=l(!1),E=async t=>{try{z.value=!0,console.log("====");const s=await he({status:1});v.value=s.filter_result,t!=="tab"&&s.filter_result.forEach(r=>{Number(r.unread_message_count)>0&&(P.value=!0)})}catch(s){$.error(s.message)}finally{z.value=!1}},q=async t=>{try{z.value=!0;const s=await he({status:2});U.value=s.filter_result,console.log(N.value),t!=="tab"&&s.filter_result.forEach(r=>{Number(r.unread_message_count)>0&&(N.value=!0)})}catch(s){$.error(s.message)}finally{z.value=!1}},ye=async()=>{await E(),await q()},ze=t=>{},xe=t=>{var r;const s=v.value.findIndex(H=>H.id===t.conversation_id);u.value>-1?(t.conversation_id===u.value?(Z.value=t,t.content.content_category==="end_conversation"&&(w.value.status=2)):s===-1&&ee(t),v.value[s].lastMessage[0]=t,v.value[s].unread_message_count++):s>-1?(v.value[s].lastMessage[0]=t,v.value[s].unread_message_count++):ee(t),t.content.content_category==="end_conversation"&&(v.value[s].status=2),(r=f.value)==null||r.play()},ee=t=>{const s={id:t.conversation_id,shop_id:t.shop_id,user_id:t.user_id,lastMessage:[t],unread_message_count:1,user:t.user,user_from:t.user_from};v.value=[s,...v.value],console.log("创建会话",s)},we=t=>{var r;const s=JSON.parse(t.data);s.type==="message"&&(console.log("message",s),s.data&&xe(s.data[0])),s.type==="read"&&(console.log("read",s),s.data[0].shop_id===w.value.shop_id&&((r=g.value)==null||r.setReadOneself()))},Ce=t=>{},Se=t=>{},Ee=()=>{let t;return t=location.origin?location.origin.replace(/^http:/,"ws:").replace(/^https:/,"wss:")+"/ws":"",t};(()=>{const t=new Je(`${Ee()}?token=${localStorage.getItem("accessToken")}&platform=admin`);t.onclose(Ce),t.onopen(ze),t.onerror(Se),t.onmessage(we),t.connect()})();const G=l(0),te=l(null),Ie=async()=>{try{const t=Ue();(await De({status:1})).errcode===0&&t.setImPresence(1);const r=await Pe({page:1});G.value=r.total,G.value>0&&Re(()=>{te.value.showWin()})}catch(t){$.error(t.message)}finally{}};He("receiveValueFromGrandChild",t=>{console.log("receiveValueFromGrandChild",t),v.value.map(s=>{s.id===t.conversation_id&&(s.lastMessage=[t])})});const se=We().currentRoute.value.query;return Te(async()=>{if(await Ie(),await E(),await q(),se.id){const t=v.value.find(s=>s.id===parseInt(se.id));console.log(t),t&&await S(t)}}),(t,s)=>{var ae,ie;const r=W("SvgIcon"),H=W("el-icon"),Me=W("el-button"),ne=W("el-badge"),oe=W("a-spin");return o(),i("div",Ye,[e("div",je,[e("div",Ke,[e("div",Xe,[e("div",Ze,[e("div",et,[e("span",tt,[d(r,{name:"im-search",width:"16",height:"16"})]),B(e("input",{ref_key:"searchInput",ref:Q,"onUpdate:modelValue":s[0]||(s[0]=n=>b.value=n),onFocus:me,onBlur:pe,class:"super-search-box-module_input_3HdzN",placeholder:"搜索最近联系人、聊天记录"},null,544),[[Ne,b.value]]),B(e("div",st,[d(H,{onClick:de(ge,["stop","prevent"]),size:"13",color:"#797979"},{default:C(()=>[d(y(ue))]),_:1})],512),[[Y,b.value!=""]])]),B(d(Me,{class:"super-search-btn",type:"primary",size:"mini",onClick:fe},{default:C(()=>s[4]||(s[4]=[_e("搜索")])),_:1},512),[[Y,A.value&&b.value!=""]])])]),B(e("div",nt,[e("div",ot,[_.value.userList.length>0?(o(),i("div",at,[e("div",it,"联系人("+c(((ae=_.value.userList)==null?void 0:ae.length)||0)+")",1),(o(!0),i(L,null,F(_.value.userList,(n,I)=>{var h,m,p;return o(),i("div",{class:"reception-filter-item cursor-pointer",key:I,onClick:M=>S(n)},[e("div",ct,[e("span",lt,[(h=n.user)!=null&&h.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,dt)):(o(),i("img",vt))])]),e("div",ut,[e("div",_t,[e("div",ht,c((p=n.user)==null?void 0:p.username),1),e("div",mt,c(n.user_from),1)])])],8,rt)}),128))])):k("",!0),_.value.conversationList.length>0?(o(),i("div",pt,[e("div",gt,"聊天记录("+c(((ie=_.value.conversationList)==null?void 0:ie.length)||0)+")",1),(o(!0),i(L,null,F(_.value.conversationList,(n,I)=>{var h,m,p;return o(),i("div",{class:"reception-filter-item cursor-pointer",key:I,onClick:M=>S(n)},[e("div",bt,[e("span",kt,[(h=n.user)!=null&&h.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,yt)):(o(),i("img",zt))])]),e("div",xt,[e("div",wt,[e("div",Ct,c((p=n.user)==null?void 0:p.username),1),e("div",St,c(n.user_from),1)]),e("div",Et,[e("div",It,c(b.value),1),e("div",Mt,[d(y(j),{time:n.add_time},null,8,["time"])])])])],8,ft)}),128))])):k("",!0)])],512),[[Y,A.value]]),e("div",Lt,[e("div",$t,[e("div",Wt,[e("div",Tt,[e("div",Nt,[e("div",{class:O(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":x.value===1}]),onClick:s[1]||(s[1]=n=>R(1))},[d(ne,{"is-dot":"",offset:[-80,15],color:P.value?"#f33":"#fff"},{default:C(()=>[e("div",Rt,"会话中("+c(v.value.length)+")",1)]),_:1},8,["color"])],2),e("div",{class:O(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":x.value===2}]),onClick:s[2]||(s[2]=n=>R(2))},[d(ne,{"is-dot":"",offset:[-80,15],color:N.value?"#f33":"#fff"},{default:C(()=>[e("div",At,"已结束("+c(U.value.length)+")",1)]),_:1},8,["color"])],2)])])])]),x.value===1?(o(),i(L,{key:0},[e("div",Ht,[d(Ve,{ref_key:"CurrentQueueNumbererRef",ref:te,onClose:ye,style:{width:"100%"}},{default:C(()=>[e("div",Bt,[e("div",null,[s[5]||(s[5]=_e(" 待接入数量：")),e("span",Ft,c(G.value),1)]),d(r,{class:"zenticon zenticon-right",name:"im-arrow",width:"12",height:"12"})])]),_:1},512)]),e("div",Ot,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",Vt,[z.value?(o(),J(oe,{key:1,spinning:z.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(o(),i("div",Dt,[(o(!0),i(L,null,F(v.value,(n,I)=>{var h,m,p,M,re,ce,le;return o(),i("div",{class:O(["conversation-list-item",{"conversation-list-item-active":u.value==n.id}]),onClick:Le=>S(n)},[e("div",Qt,[e("div",Ut,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",qt,[e("div",Gt,[d(H,{onClick:de(Le=>be(n),["stop","prevent"]),size:"20",color:"#bbbbbb"},{default:C(()=>[d(y(ue))]),_:2},1032,["onClick"])])]),e("div",Jt,[e("div",Yt,[e("span",jt,[(h=n.user)!=null&&h.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,Kt)):(o(),i("img",Xt))]),n.unread_message_count>0?(o(),i("span",Zt,c(n.unread_message_count),1)):k("",!0)])]),e("div",es,[e("div",ts,[e("div",ss,c(n.user?n.user.username:""),1),e("div",ns,[e("div",os,[e("div",as,c(n.user_from),1)])])]),e("div",is,[n.lastMessage?(o(),i("div",rs,[((p=n.lastMessage[0])==null?void 0:p.message_type)=="text"?(o(),i("div",cs,[e("div",{class:"conversation-list-item-message-text",innerHTML:(re=(M=n.lastMessage[0])==null?void 0:M.content)==null?void 0:re.content},null,8,ls)])):(o(),i("div",ds,c((ce=n.lastMessage[0])==null?void 0:ce.message_type_text),1))])):k("",!0),e("div",vs,[d(y(j),{time:(le=n.lastMessage[0])==null?void 0:le.send_time},null,8,["time"])])])])],10,Pt)}),256))]))])])])],64)):k("",!0),x.value===2?(o(),i("div",us,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",_s,[z.value?(o(),J(oe,{key:1,spinning:z.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(o(),i("div",hs,[(o(!0),i(L,null,F(U.value,(n,I)=>{var h,m,p;return o(),i("div",{class:O(["conversation-list-item",{"conversation-list-item-active":u.value==n.id}]),onClick:M=>S(n,x.value)},[e("div",ps,[e("div",gs,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",fs,[e("div",bs,[e("span",ks,[(h=n.user)!=null&&h.avatar?(o(),i("img",{key:0,class:"zent-avatar-image",src:y(V)((m=n.user)==null?void 0:m.avatar)},null,8,ys)):(o(),i("img",zs))]),n.unread_message_count>0?(o(),i("span",xs,c(n.unread_message_count),1)):k("",!0)])]),e("div",ws,[e("div",Cs,[e("div",Ss,c(n.user?n.user.username:""),1),e("div",Es,[e("div",Is,[e("div",Ms,c(n.user_from),1)])])]),e("div",Ls,[n.lastMessage?(o(),i("div",$s,c(((p=n.lastMessage[0].content)==null?void 0:p.content)||n.lastMessage[0].message_type_text),1)):k("",!0),e("div",Ws,[d(y(j),{time:n.add_time},null,8,["time"])])])])],10,ms)}),256))]))])])])):k("",!0)])]),s[6]||(s[6]=e("div",{class:"im-resizable-anchor"},null,-1)),u.value?(o(),J(Fe,{key:0,ref_key:"ImMessageRef",ref:g,conversationId:u.value,"onUpdate:conversationId":s[3]||(s[3]=n=>u.value=n),currentNewMessage:Z.value,currentConversationData:w.value,msgType:x.value,onResumeConversation:ke,on_getConversationStrat:E},null,8,["conversationId","currentNewMessage","currentConversationData","msgType"])):k("",!0)]),d(qe,{ref_key:"promptToneRef",ref:f},null,512)])}}}),un=Be(Ts,[["__scopeId","data-v-1c5c962c"]]);export{un as default};
