import"./index-CeQDmMxd.js";import{i as J}from"./format-CRgx78oe.js";import{F as P}from"./UploadAvatar.vue_vue_type_style_index_0_scoped_9bfcfc35_lang-BDvYUQtN.js";import"./vuedraggable.umd-DAKh-e3Q.js";import{d as Q,i as u,K as X,aU as Y,q as Z,I as d,r as c,c as _,o as v,e as i,b as s,w as n,g as l,dB as ee,dC as I,bm as te,D as oe,F as le,a as ae,j as se,E as L,_ as re}from"./index-DrbzVNl6.js";import{h as ie,n as ne,o as de}from"./gallery-DHkpVoP3.js";import{b as ue}from"./time-Bh5UhrfW.js";import{_ as ce}from"./DialogForm.vue_vue_type_script_setup_true_lang-DqYSRv0_.js";import"./Image.vue_vue_type_script_setup_true_lang-BWzCs9jv.js";const pe={class:"container"},me={class:"content_wrapper"},fe={class:"lyecs-form-table"},ve={key:0,class:"video-preview"},_e=["src"],ge={key:1,style:{width:"400px"}},ye={class:"gallery-add-item flex flex-justify-center flex-align-center"},be={class:"extra mt10"},xe={class:"flex flex-justify-between"},he={class:"con-btn ml10 flex flex-align-center flex-justify-center"},Ue=Q({__name:"VideoEdit",props:{id:{type:Number,default:0},parentId:{type:Number,default:0},act:{type:String,default:""},isDialog:Boolean},emits:["submitCallback","okType","callback"],setup(N,{expose:S,emit:j}){const z=u(),x=X();x.updateConfig();const g=x.config.uploadMaxSize,m=u([]),f=u(!0),B={strokeWidth:5,format:e=>`${parseFloat((e??"0").toString())}%`},E=N,{id:h,act:U}=Y(E),F=U.value=="add"?"create":"update",R=(e,t,a)=>{if(t)if(t.length>20){a(new Error("视频名称不能超过20个字"));return}else a();else{a(new Error("视频名称不能为空"));return}},k=j,w=u();let o=u({videoUrl:"",videoName:"",videoCover:"",format:"",duration:"",size:""});Z(()=>{U.value==="detail"&&T(),b(0)});const V=u([]),y=u(!1),b=async e=>{y.value=!0;try{const t=await ie();V.value=t.records,e>0&&(o.value.galleryId=e,k("callback",0))}catch(t){d.error(t.message)}finally{setTimeout(()=>{y.value=!1},200)}},T=async()=>{try{const e=await ne({id:h.value});o.value=e}catch(e){d.error(e.message)}},M={".mp4":"video/mp4"},$=e=>{f.value=!0;const t="."+e.name.split(".").pop().toLowerCase();if(!Object.keys(M).includes(t))return d.error(`不支持 ${t} 格式的视频文件`),!1;const a=e.size/1024/1024<Number(g);return a||d.error(`只能上传${g}M以内的视频`),G(e),a},G=e=>{const t=URL.createObjectURL(e),a=document.createElement("video");a.src=t,a.onloadedmetadata=()=>{const p=a.duration;o.value.duration=ue(p),a.currentTime=.1},a.onerror=()=>{d.error("视频文件损坏或无法读取"),URL.revokeObjectURL(t)}},q=e=>{e.file.status||(f.value=!1,m.value=[]),e.file.status=="uploading",e.file.status,e.file.status==="done"?e.file.response.code!==0?(e.file.status="error",d.error(e.file.response.message)):(m.value=[e.file],o.value.size=e.file&&e.file.size?`${(e.file.size/1024/1024).toFixed(2)}MB`:"",Object.assign(o.value,e.file.response.data),d.success("视频上传成功！"),f.value=!1):e.file.status==="error"&&d.error(`${e.file.name} 视频上传失败！`)},D=()=>{o.value.videoUrl="",o.value.videoName="",o.value.duration="",m.value=[],f.value=!0},O=async()=>{await w.value.validate();try{const e=await de(F,{id:h.value,...o.value});k("submitCallback",e),d.success("操作成功")}catch(e){d.error(e.message)}};return S({onFormSubmit:()=>{O()}}),(e,t)=>{const a=c("el-icon"),p=c("el-form-item"),A=c("TigInput"),K=c("el-option"),W=c("el-select"),C=c("el-button"),H=c("el-form");return v(),_("div",pe,[i("div",me,[i("div",fe,[s(H,{ref_key:"formRef",ref:w,model:l(o),"label-width":"auto"},{default:n(()=>[s(p,{prop:"videoUrl",label:"本地视频",rules:[{required:!0,message:"请上传本地视频!"}]},{default:n(()=>[i("div",null,[l(o).videoUrl?(v(),_("div",ve,[i("div",{class:"iconfont icon-cha1 btn-remove",onClick:D}),i("video",{src:l(J)(l(o).videoUrl),controls:"",class:"preview-video"},null,8,_e)])):(v(),_("div",ge,[s(l(ee),{name:"file",ref_key:"uploadRef",ref:z,"file-list":m.value,"onUpdate:fileList":t[0]||(t[0]=r=>m.value=r),action:l(I).prefix+"/setting/galleryVideoInfo/uploadVideo",headers:l(I).headers,showUploadList:f.value,onChange:q,"before-upload":$,progress:B,accept:".mp4,video/*"},{default:n(()=>[i("div",ye,[s(a,{size:"25"},{default:n(()=>[s(l(te))]),_:1})])]),_:1},8,["file-list","action","headers","showUploadList"])])),i("div",be," 视频大小不超过"+oe(l(g))+"MB，时长5秒-5分钟以内，建议时长15-190秒， 支持的视频文件类型 .mp4。 ",1)])]),_:1}),s(p,{prop:"videoName",label:"视频名称",rules:[{required:!0,validator:R}]},{default:n(()=>[s(A,{classType:"tig-form-input",modelValue:l(o).videoName,"onUpdate:modelValue":t[1]||(t[1]=r=>l(o).videoName=r),placeholder:"20个字以内",maxlength:20},null,8,["modelValue"])]),_:1},8,["rules"]),s(p,{prop:"galleryId",label:"所在视频相册",rules:[{required:!0,message:"视频相册不能为空!"}]},{default:n(()=>[i("div",xe,[s(W,{modelValue:l(o).galleryId,"onUpdate:modelValue":t[2]||(t[2]=r=>l(o).galleryId=r),placeholder:"请选择",style:{flex:"1"}},{default:n(()=>[(v(!0),_(le,null,ae(V.value,r=>(v(),se(K,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i("div",he,[s(l(ce),{params:{act:"add",parentId:0},path:"gallery/video/GalleryVideoEdit",title:"添加视频相册",width:"600px",onOkCallback:b},{default:n(()=>[s(C,{link:"",type:"primary"},{default:n(()=>t[5]||(t[5]=[L("添加相册")])),_:1})]),_:1}),t[7]||(t[7]=i("p",{class:"ml10 mr10",style:{"margin-bottom":"3px"}},"|",-1)),s(C,{link:"",type:"primary",loading:y.value,onClick:t[3]||(t[3]=r=>b(0))},{default:n(()=>t[6]||(t[6]=[L("刷新")])),_:1},8,["loading"])])])]),_:1}),s(p,{prop:"videoCover",label:"视频封面"},{default:n(()=>[s(l(P),{photo:l(o).videoCover,"onUpdate:photo":t[4]||(t[4]=r=>l(o).videoCover=r)},null,8,["photo"]),t[8]||(t[8]=i("div",{class:"extra"}," 建议尺寸：800*800px，支持.jpg，.gif，.png格式，大小不超过10MB。如果不添加封面， 系统会默认截取视频的第一个画面作为封面。 ",-1))]),_:1})]),_:1},8,["model"])])])])}}}),Be=re(Ue,[["__scopeId","data-v-9bf26362"]]);export{Be as default};
