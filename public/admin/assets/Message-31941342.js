import{i as $,p as Q,e as _e,u as be,r as xe,_ as Ce}from"./format-4e0206d3.js";import{s as ze,S as Ie,c as we,d as Se,a as $e,b as Me,e as De,f as Te}from"./SendMessage-5064840d.js";import{e as Ee}from"./util-1ee03ed8.js";import Be from"./Reconnection-dff7d02f.js";import{d as ee,j as y,o as a,c as n,_ as te,m as ue,I as pe,u as Ve,x as je,r as C,e,b as v,w as N,F as D,a as Y,k as P,h as u,f as p,K as M,O as Re,H as G,G as h,cX as Fe,p as ge,i as he,v as ve,n as F,C as J,E as Ne,aO as me,dz as Oe}from"./index-7c2d2aef.js";/* empty css             *//* empty css                                                                    */import{P as Le}from"./Pagination-8eb7b6b1.js";import{u as Ue}from"./config-9548fa9b.js";import{g as He}from"./product-689c7c1e.js";import Pe from"./OrderImList-dd01d527.js";import{e as Ge}from"./Emoji-211cad96.js";import"./index-afc4fb40.js";import"./index-57209e55.js";import"./ReconnectionList-836433e1.js";import"./StatusDot-19af4eec.js";import"./conversation-43b2bd1f.js";import"./config-e2aa16d1.js";import"./order-5e1a3c9e.js";import"./index-6c62cf9b.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-c57b9a11.js";const qe=["innerHTML"],Ae=ee({__name:"emojiHtml",props:{content:{type:String,default:""}},setup(l){const B=l,T=y("");T.value=d(B.content,Ge);function d(x,g){const b=new RegExp(`(${g.map(i=>i.name).join("|")})`,"g");return x.replace(/\[|\]/g,"").replace(b,i=>{const c=g.find(I=>I.name===i);return c?"<img class='emoji' src='http://oss.tigshop.com/official/emoji/"+c.id+".png'>":i})}return(x,g)=>(a(),n("div",{innerHTML:T.value},null,8,qe))}}),Ze=te(Ae,[["__scopeId","data-v-7e152687"]]),fe=l=>(ge("data-v-d4da416c"),l=l(),he(),l),Ke={class:"goods-search-container"},We={class:"goods-toolbar"},Xe={class:"goods-recommend-list"},Je={class:"check-box"},Qe=["onClick"],Ye=["onClick"],et={class:"name"},tt={class:"price"},st={class:"goods-choosed-box"},at={key:0,class:"page"},ot={class:"bot"},nt={key:0,class:"goods-choosed-box-left"},it=fe(()=>e("div",null,"尚未选择商品",-1)),ct=[it],rt={key:1,class:"goods-choosed-box-left-have"},lt=fe(()=>e("div",null,"已选择",-1)),dt={class:"im"},_t=["onClick"],ut=ee({__name:"SelectImProduct",props:ue({messageInfo:{type:Object,default:{}}},{linkSelectData:{type:Array,default:[]},linkSelectDataModifiers:{}}),emits:ue(["sendMessage"],["update:linkSelectData"]),setup(l,{emit:B}){const T=l,d=y(!0),x=y(0),g=Ue(),b=y([]),i=pe({page:1,size:g.get("page_size"),sort_field:"",sort_order:"",keyword:""});Ve(l,"linkSelectData");const c=y([]),I=async()=>{d.value=!0;try{const r=await He({...i});b.value=r.filter_result,b.value.forEach(o=>{o.check=c.value.some(f=>f.product_id===o.product_id)}),x.value=r.total}catch(r){M.error(r.message)}finally{d.value=!1}},E=r=>{const o=c.value.findIndex(f=>f.product_id===r.product_id);o!==-1?(c.value.splice(o,1),r.check=!1):c.value.length<3?(c.value.push(r),r.check=!0):M.error("一次最多发送三个商品")},V=r=>{if(r.check)E(r);else{const o=c.value.findIndex(f=>f.product_id===r.product_id);o!==-1&&c.value.splice(o,1)}},q=r=>{const o=c.value.splice(r,1)[0],f=b.value.findIndex(w=>w.product_id===o.product_id);f!==-1&&(b.value[f].check=!1)},S=()=>{O()},O=()=>{c.value.forEach(r=>{K(r)})},A=Re("receiveValueFromGrandChild"),Z=B,K=async r=>{try{let o={};Object.assign(o,T.messageInfo,{content:{message_type:"custom",product:r||""}});const f=await ze(o);Z("sendMessage",f.item),A(f.item),c.value=[],b.value.forEach(w=>w.check=!1)}catch(o){console.log(o)}finally{}};return je(()=>{I()}),(r,o)=>{const f=C("el-input"),w=C("el-button"),W=C("el-space"),j=C("el-checkbox"),R=C("el-image"),L=C("el-empty"),X=C("a-spin");return a(),n("div",Ke,[e("div",We,[v(W,null,{default:N(()=>[v(f,{style:{width:"190px"},modelValue:i.keyword,"onUpdate:modelValue":o[0]||(o[0]=_=>i.keyword=_),placeholder:"商品名称/货号"},null,8,["modelValue"]),v(w,{onClick:I},{default:N(()=>[G("搜索")]),_:1})]),_:1})]),e("div",Xe,[d.value?u("",!0):(a(),n(D,{key:0},[x.value>0?(a(!0),n(D,{key:0},Y(b.value,_=>(a(),n("div",{key:_.product_id,class:"product-item"},[e("div",Je,[v(j,{modelValue:_.check,"onUpdate:modelValue":k=>_.check=k,onChange:k=>V(_)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),e("div",{class:"image-box",onClick:k=>E(_)},[v(R,{fit:"cover",class:"image",src:p($)(_.pic_thumb)},null,8,["src"])],8,Qe),e("div",{class:"info-box",onClick:k=>E(_)},[e("div",et,h(_.product_name),1),e("div",tt,h(p(Q)(_.product_price)),1)],8,Ye)]))),128)):(a(),P(L,{key:1,description:"暂无商品～"}))],64)),v(X,{spinning:d.value,style:{width:"100%","margin-top":"100px"}},null,8,["spinning"])]),e("div",st,[x.value>0?(a(),n("div",at,[v(p(Le),{page:i.page,"onUpdate:page":o[1]||(o[1]=_=>i.page=_),size:i.size,"onUpdate:size":o[2]||(o[2]=_=>i.size=_),total:x.value,onCallback:I,layout:"slot, prev, next",background:!1},null,8,["page","size","total"])])):u("",!0),e("div",ot,[c.value.length===0?(a(),n("div",nt,ct)):(a(),n("div",rt,[lt,(a(!0),n(D,null,Y(c.value,(_,k)=>(a(),n("div",{class:"image-list",key:_.product_id},[e("div",dt,[v(R,{fit:"cover",class:"lg-image",src:p($)(_.pic_thumb)},null,8,["src"]),e("div",{class:"del-bb",onClick:Fe(U=>q(k),["stop"])},null,8,_t)])]))),128))])),e("div",null,[v(w,{onClick:S,disabled:c.value.length===0,type:"primary"},{default:N(()=>[G("确定")]),_:1},8,["disabled"])])])])])}}});const vt=te(ut,[["__scopeId","data-v-d4da416c"]]),z=l=>(ge("data-v-18e596f1"),l=l(),he(),l),mt={class:"im-center"},pt={class:"conversation-title-m_wrap_qcEBo"},gt={key:0,class:"conversation-title-m_name_1G8ZZ"},ht={class:"name"},ft={class:"flex"},yt={key:0,class:"reconnection"},kt={class:"message-list im-message-m_container_31cB1 im-message-box"},bt={class:"im-message-item__time"},xt={key:0,class:"im-message-item__username"},Ct={class:"content__outer"},zt={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},It=["src"],wt=["src"],St={key:2,class:"zent-avatar-image",src:Ce},$t={key:0,class:"im-message-item__content"},Mt={key:0,class:"im-message-item__content-value"},Dt={key:1,class:"im-message-item__content"},Tt={class:"im-message-item__content-value"},Et={key:2,class:"im-message-item__content"},Bt={key:0,class:"im-message-item__content-value im-message-item__content-card"},Vt=["href"],jt={class:"im-message-item__content-card-title"},Rt={class:"im-message-item__content-card-detail"},Ft={class:"im-message-item__content-card-figure"},Nt={class:"im-message-item__content-card-desc"},Ot={key:1,class:"im-message-item__content-card-link"},Lt={class:"im-message-item__content-card-title"},Ut={class:"im-message-item__content-card-detail"},Ht={class:"im-message-item__content-card-figure"},Pt={class:"right-info"},Gt={class:"im-message-item__content-card-order-name"},qt={class:"im-message-item__content-card-order-info"},At={key:1},Zt={key:0,class:"im-message-item__read"},Kt={key:1,class:"im-message-item__unread"},Wt={key:1},Xt={class:"im-message-item notice"},Jt={class:"im-message-item__content"},Qt={class:"im-edit-box"},Yt={key:0,class:"im-edit-box-mask"},es=z(()=>e("div",{class:"im-resizable-anchor"},null,-1)),ts={class:"im-resizable im-right"},ss={class:"zent-tabs zent-tabs-type__normal right-plugins-m_tabs_1oN_5"},as={class:"zent-tabs-nav zent-tabs-nav-type__normal"},os={class:"zent-tabs-nav-content"},ns={class:"zent-tabs-scroll"},is=z(()=>e("div",{class:"zent-tabs-tab-inner"},"资料",-1)),cs=[is],rs=z(()=>e("div",{class:"zent-tabs-tab-inner"},"订单",-1)),ls=[rs],ds=z(()=>e("div",{class:"zent-tabs-tab-inner"},"商品",-1)),_s=[ds],us={role:"tabpanel",class:"zent-tabs-panel thin-line"},vs={class:"profile-anonymous-m_line_kvakE",style:{height:"auto"}},ms={class:"zent-badge zent-badge--has-content conversation-list-item-avatar",style:{"margin-right":"16px"}},ps={class:"zent-badge-content"},gs={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},hs={class:"zent-avatar im-message-item__avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},fs=["src"],ys=["src"],ks={class:"wechat-from"},bs={class:"name"},xs=z(()=>e("div",{class:"tags"},null,-1)),Cs={class:"profile-anonymous-m_line_kvakE"},zs=z(()=>e("label",null,"昵称：",-1)),Is={class:"profile-anonymous-m_line_kvakE"},ws=z(()=>e("label",null,"会话来源：",-1)),Ss={role:"tabpanel",class:"zent-tabs-panel"},$s={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},Ms=z(()=>e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话总结：",-1)),Ds={class:"edit-input"},Ts={class:"profile-anonymous-m_line_kvakE",style:{height:"auto","flex-direction":"column","align-items":"flex-start"}},Es=z(()=>e("label",{style:{flex:"auto",margin:"8px 0 4px 0"}},"会话备注：",-1)),Bs={class:"edit-input"},Vs={class:"action"},js={key:1,class:"im-layout"},Rs={class:"im-default-box"},Fs={class:"im-default"},Ns={class:"im-default-icon"},Os=z(()=>e("div",{class:"im-default-text"},[e("span",null,"没有选中会话哦")],-1)),Ls=ee({__name:"Message",props:{conversationId:{type:Number,default:""},currentNewMessage:{type:Object,default:()=>({})},currentConversationData:{type:Object,default:()=>({})},msgType:{type:Number,default:1},status:{type:Number,default:1},preview:{type:Boolean,default:!1}},emits:["update:conversationId","resumeConversation","_getConversationStrat"],setup(l,{expose:B,emit:T}){const d=l,x=y({}),g=y([]),b=y(!1),i=pe({conversation_id:d.conversationId,sort_order:"desc",first_id:-1}),c=y(null);let I=y(!0),E=y(0);const V=()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight)},q=()=>{if(R(),c.value){I.value&&(E.value=c.value.scrollTop,I.value=!1);const{scrollTop:s,scrollHeight:m,clientHeight:H}=c.value;s==0&&b.value==!1&&g.value.length>0&&(i.first_id=g.value[0].id,r())}},S=T,O=s=>{g.value.push(s),J(()=>{V()})},A=Ne(),Z=()=>{me.confirm("确认重新接入会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{we({user_id:d.currentConversationData.user_id,user_from:d.currentConversationData.user_from}).then(s=>{d.preview?A.push({path:"/im/index",query:{id:s.item.id}}):(i.conversation_id=s.item.id,i.first_id=-1,g.value=[],b.value=!1,r(),S("resumeConversation",!0))}).catch(s=>{M.error(s.message)})}).catch(()=>{})},K=async()=>{me.confirm("确认结束该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Se({conversation_id:i.conversation_id}).then(s=>{o.value={},i.conversation_id=-1,S("update:conversationId",-1),S("_getConversationStrat")}).catch(s=>{M.error(s.message)})})},r=async()=>{try{const s=await $e(i);if(s.filter_result.length==0){b.value=!0;return}g.value.unshift(...s.filter_result),J(()=>{i.first_id==-1?V():setTimeout(()=>{c.value&&(c.value.scrollTop=E.value,I.value=!0)},0)})}catch(s){console.error(s)}},o=y({}),f=async()=>{try{const s=await Te({conversation_id:i.conversation_id});o.value=s.item}catch(s){console.error(s)}},w=async()=>{try{const s=await Me({conversation_id:o.value.id,remark:o.value.remark,summary:o.value.summary});M.success("保存成功")}catch(s){M.error(s.message)}};ve(()=>d.conversationId,s=>{s&&s!=-1&&(i.conversation_id=s,i.first_id=-1,g.value=[],b.value=!1,r(),f()),Object.keys(d.currentConversationData).length>0&&(x.value={conversation_id:d.currentConversationData.id,user_id:d.currentConversationData.user_id,shop_id:d.currentConversationData.shop_id})},{immediate:!0,deep:!0});const W=s=>g.value.findIndex(m=>m.id===s.id);ve(()=>d.currentNewMessage,s=>{Object.keys(s).length>0&&W(s)===-1&&(g.value=[...g.value,s],J(()=>{V()}))},{immediate:!0,deep:!0});const j=y(!1),R=()=>{d.currentConversationData.unread_message_count>0&&!j.value&&L(d.currentConversationData)},L=async s=>{try{j.value=!0;const m=await De({conversation_id:s.id,user_id:s.user_id,shop_id:s.shop_id});d.currentConversationData.unread_message_count=0}catch(m){M.error(m.message)}finally{j.value=!1}},X=()=>{g.value.forEach(s=>{s.type===2&&s.is_read===0&&(s.is_read=1)})},_=()=>{S("update:conversationId",-1),S("_getConversationStrat")};B({_setRead:L,setReadOneself:X});const k=y(1),U=s=>{k.value=s};return y([]),(s,m)=>{var ae,oe,ne,ie,ce,re;const H=C("el-image"),se=C("el-input"),ye=C("el-button"),ke=C("el-icon");return a(),n(D,null,[i.conversation_id!=-1?(a(),n("div",{key:0,class:F([l.preview?"preview-style":"","im-layout"]),onClick:R},[e("div",mt,[e("div",pt,[o.value.user?(a(),n("div",gt,[e("div",ht,h((ae=l.currentConversationData.user)==null?void 0:ae.username),1),e("div",ft,[l.preview?u("",!0):(a(),n("div",yt,[v(Be,{onServersUpdated:_,conversation_id:i.conversation_id},null,8,["conversation_id"])])),e("div",{class:"reception-panel-toolbar-waiting",onClick:K}," 结束 ")])])):u("",!0)]),e("div",kt,[e("div",{ref_key:"messageBoxRef",ref:c,onScroll:q,class:"message-list-content"},[(a(!0),n(D,null,Y(g.value,(t,Us)=>{var le,de;return a(),n(D,null,[t.type!==3?(a(),n("div",{key:0,class:F(["im-message-item text",{left:t.type===1,right:t.type===2}])},[e("div",bt,h(t.send_time),1),t.type===2&&t.servant?(a(),n("div",xt,h(t.servant.username),1)):u("",!0),e("div",Ct,[e("span",zt,[t.type===2&&t.servant.avatar?(a(),n("img",{key:0,class:"zent-avatar-image",src:p(_e)(t.servant.avatar)},null,8,It)):t.type===1&&t.user.avatar?(a(),n("img",{key:1,class:"zent-avatar-image",src:p(_e)(t.user.avatar)},null,8,wt)):(a(),n("img",St))]),t.message_type=="text"?(a(),n("div",$t,[t.content&&t.content.content?(a(),n("div",Mt,[v(p(Ze),{content:t.content.content},null,8,["content"])])):u("",!0)])):u("",!0),t.content&&t.message_type=="image"?(a(),n("div",Dt,[e("div",Tt,[v(H,{style:{height:"200px"},src:p($)((le=t.content)==null?void 0:le.pic),"zoom-rate":1.2,"max-scale":7,"min-scale":.2,"preview-src-list":[p($)((de=t.content)==null?void 0:de.pic)],"hide-on-click-modal":"",fit:"cover"},null,8,["src","preview-src-list"])])])):u("",!0),t.message_type=="custom"?(a(),n("div",Et,[t.content?(a(),n("div",Bt,["product"in t.content?(a(),n("a",{key:0,href:p(be)({path:"product",sn:t.content.product.product_sn}),target:"_blank",class:"im-message-item__content-card-link"},[e("h4",jt,h(t.content.product.product_name),1),e("div",Rt,[e("figure",Ft,[v(H,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:p($)(t.content.product.pic_url?t.content.product.pic_url:t.content.product.pic_thumb)},null,8,["src"])]),e("p",Nt,h(p(Q)(t.content.product.product_price)),1)])],8,Vt)):u("",!0),"order"in t.content?(a(),n("a",Ot,[e("h4",Lt,h(t.content.order.order_status_name),1),e("div",Ut,[e("figure",Ht,[v(H,{fit:"cover",width:"100%",style:{border:"1px solid #f5f5f5"},src:p($)(t.content.order.pic_url?t.content.order.pic_url:t.content.order.pic_thumb)},null,8,["src"])]),e("div",Pt,[e("div",Gt,h(t.content.order.product_name),1),e("div",qt,[e("div",null,"共"+h(t.content.order.product_num)+"件商品",1),e("div",null,"合计"+h(p(Q)(t.content.order.total_amount)),1)])])])])):u("",!0)])):u("",!0)])):u("",!0)]),t.type===2?(a(),n("div",At,[t.is_read?(a(),n("span",Zt,"已读")):(a(),n("span",Kt,"未读"))])):u("",!0)],2)):u("",!0),t.type===3&&t.message_type==="text"?(a(),n("div",Wt,[e("div",Xt,[e("div",Jt,h(t.send_time)+" "+h(t.content?t.content.content:""),1)])])):u("",!0)],64)}),256))],544)]),e("div",Qt,[l.status===2?(a(),n("div",Yt,[G(" 如需联系客户，请点击 "),e("a",{class:"zent-link",onClick:Z},"开始对话")])):(a(),P(Ie,{key:1,messageInfo:x.value,onSendMessage:O},null,8,["messageInfo"]))])]),es,e("div",ts,[e("div",ss,[e("div",as,[e("div",os,[e("div",ns,[e("div",{class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":k.value==1}]),onClick:m[0]||(m[0]=t=>U(1))},cs,2),e("div",{class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":k.value==2}]),onClick:m[1]||(m[1]=t=>U(2))},ls,2),l.preview?u("",!0):(a(),n("div",{key:0,class:F(["zent-tabs-tab",{"zent-tabs-tab__actived":k.value==3}]),onClick:m[2]||(m[2]=t=>U(3))},_s,2))])])])]),e("div",null,[k.value==1?(a(),n(D,{key:0},[e("div",us,[e("div",vs,[e("label",null,[e("div",ms,[e("div",ps,[e("span",gs,[e("span",hs,[p(Ee)(String((oe=o.value.user)==null?void 0:oe.avatar))=="def"?(a(),n("img",{key:0,class:"zent-avatar-image",src:p(xe)((ne=o.value.user)==null?void 0:ne.avatar)},null,8,fs)):(a(),n("img",{key:1,class:"zent-avatar-image",src:p($)((ie=o.value.user)==null?void 0:ie.avatar)},null,8,ys))])])])])]),e("div",ks,[e("div",bs,h((ce=o.value.user)==null?void 0:ce.username),1),xs])]),e("div",Cs,[zs,e("span",null,h((re=o.value.user)==null?void 0:re.nickname),1)]),e("div",Is,[ws,e("span",null,h(o.value.user_from),1)])]),e("div",Ss,[e("div",$s,[Ms,e("div",Ds,[v(se,{modelValue:o.value.summary,"onUpdate:modelValue":m[3]||(m[3]=t=>o.value.summary=t)},null,8,["modelValue"])])]),e("div",Ts,[Es,e("div",Bs,[v(se,{modelValue:o.value.remark,"onUpdate:modelValue":m[4]||(m[4]=t=>o.value.remark=t),rows:6,type:"textarea"},null,8,["modelValue"])])]),e("div",Vs,[v(ye,{type:"primary",disabled:o.value.remark=="",onClick:m[5]||(m[5]=t=>w())},{default:N(()=>[G("保存")]),_:1},8,["disabled"])])])],64)):k.value==2?(a(),P(Pe,{key:1,preview:l.preview,userId:l.currentConversationData.user_id},null,8,["preview","userId"])):k.value==3?(a(),P(vt,{key:2,messageInfo:x.value,onSendMessage:O},null,8,["messageInfo"])):u("",!0)])])],2)):u("",!0),i.conversation_id==-1?(a(),n("div",js,[e("div",Rs,[e("div",Fs,[e("div",Ns,[v(ke,{color:"#d5d5d5",size:"50"},{default:N(()=>[v(p(Oe))]),_:1})]),Os])])])):u("",!0)],64)}}});const la=te(Ls,[["__scopeId","data-v-18e596f1"]]);export{la as default};
