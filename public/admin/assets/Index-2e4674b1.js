import{d as $e,j as l,E as Te,x as We,r as T,o as n,c as i,e,b as d,$ as B,cP as Ne,a0 as Y,w as S,cX as de,G as c,F as W,a as F,h as y,n as V,q as ve,k as j,K as N,C as Re,J as Ae,f as k,dy as ue,H as _e,p as He,i as Oe,aO as Be,_ as Fe}from"./index-7c2d2aef.js";import{e as D,_ as P}from"./format-4e0206d3.js";import Ve from"./Message-31941342.js";import{g as he,d as De}from"./SendMessage-5064840d.js";import Pe from"./CurrentQueueNumber-8580dbdc.js";import{g as Ue,s as Ge,a as Qe}from"./conversation-43b2bd1f.js";/* empty css                                               */import"./zh-cn-8c8b9709.js";import{_ as K}from"./QueueList-acf8597d.js";import{u as qe}from"./im-efe55bdf.js";import Je from"./promptTone-f8536709.js";import"./config-9548fa9b.js";import"./config-e2aa16d1.js";import"./util-1ee03ed8.js";import"./Reconnection-dff7d02f.js";import"./ReconnectionList-836433e1.js";import"./StatusDot-19af4eec.js";/* empty css             *//* empty css                                                                    */import"./Pagination-8eb7b6b1.js";import"./product-689c7c1e.js";import"./OrderImList-dd01d527.js";import"./order-5e1a3c9e.js";import"./index-6c62cf9b.js";import"./DialogForm.vue_vue_type_script_setup_true_lang-c57b9a11.js";import"./Emoji-211cad96.js";import"./index-afc4fb40.js";import"./index-57209e55.js";import"./DeleteRecord.vue_vue_type_script_setup_true_lang-ae1bade7.js";import"./brand-995f2ca4.js";const me=class X{log(a,g){if(!X.console)return;const f="#ff4d4f";console.log(`%c ${a} %c ${g} %c`,`background:${f};border:1px solid ${f}; padding: 1px; border-radius: 2px 0 0 2px; color: #fff;`,`border:1px solid ${f}; padding: 1px; border-radius: 0 2px 2px 0; color: ${f};`,"background:transparent")}closeConsole(){X.console=!1}};me.console=!0;let Ye=me;class je extends Ye{constructor(){super(...arguments),this.listeners={}}addEventListener(a,g){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].indexOf(g)===-1&&this.listeners[a].push(g)}removeEventListener(a){this.listeners[a]=[]}dispatchEvent(a,g){const f=this.listeners[a]||[];f.length!==0&&f.forEach(u=>{u.call(this,g)})}}class Ke extends je{constructor(a){super(),this.url="",this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectInterval=1e3,this.heartbeatInterval=1e3*15,this.stopWs=!1,this.url=a}onopen(a){this.addEventListener("open",a)}onmessage(a){this.addEventListener("message",a)}onclose(a){this.addEventListener("close",a)}onerror(a){this.addEventListener("error",a)}send(a){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(a):console.error("[WebSocket] 未连接")}connect(){this.reconnectAttempts===0&&this.log("WebSocket",`初始化连接中...          ${this.url}`),!(this.socket&&this.socket.readyState===WebSocket.OPEN)&&(this.socket=new WebSocket(this.url),this.socket.onopen=a=>{this.stopWs=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.log("WebSocket",`连接成功,等待服务端数据推送[onopen]...     ${this.url}`),this.dispatchEvent("open",a)},this.socket.onmessage=a=>{this.dispatchEvent("message",a),this.startHeartbeat()},this.socket.onclose=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接断开[onclose]...    ${this.url}`),this.stopWs||this.handleReconnect(),this.dispatchEvent("close",a)},this.socket.onerror=a=>{this.reconnectAttempts===0&&this.log("WebSocket",`连接异常[onerror]...    ${this.url}`),this.closeHeartbeat(),this.dispatchEvent("error",a)})}handleReconnect(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.log("WebSocket",`尝试重连... (${this.reconnectAttempts}/${this.maxReconnectAttempts})       ${this.url}`),setTimeout(()=>{this.connect()},this.reconnectInterval)):(this.closeHeartbeat(),this.log("WebSocket",`最大重连失败，终止重连: ${this.url}`))}close(){this.socket&&(this.stopWs=!0,this.socket.close(),this.socket=null,this.removeEventListener("open"),this.removeEventListener("message"),this.removeEventListener("close"),this.removeEventListener("error")),this.closeHeartbeat()}startHeartbeat(){this.stopWs||(this.heartbeatTimer&&this.closeHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.socket?(this.socket.send(JSON.stringify({type:"heartBeat",data:{}})),this.log("WebSocket","送心跳数据...")):console.error("[WebSocket] 未连接")},this.heartbeatInterval))}closeHeartbeat(){clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0}}const Xe=w=>(He("data-v-e7e92c40"),w=w(),Oe(),w),Ze={class:"app-layout-m_content_wYOV9"},et={class:"im"},tt={class:"im-resizable im-left reception-panel im-resizable-right"},st={class:"reception-panel-search"},ot={class:"super-search-box-module_wrap_i3xn3 reception-panel-search-searcher"},nt={class:"super-search-box-module_search_2qwmN"},at={class:"super-search-box-module_icon_1LUOA"},it={class:"conversation-list-item-del"},rt={class:"reception-panel-mask"},ct={class:"reception-filter-content"},lt={key:0,class:"reception-filter-list"},dt={class:"reception-filter-item-title"},vt=["onClick"],ut={class:"reception-filter-item-head"},_t={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ht=["src"],mt={key:1,class:"zent-avatar-image",src:P},pt={class:"reception-filter-item-body"},gt={class:"reception-filter-item-name"},ft={class:"name"},bt={class:"label text-transform"},yt={key:1,class:"reception-filter-list"},kt={class:"reception-filter-item-title"},zt=["onClick"],xt={class:"reception-filter-item-head"},wt={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},Ct=["src"],St={key:1,class:"zent-avatar-image",src:P},Lt={class:"reception-filter-item-body"},It={class:"reception-filter-item-name"},Et={class:"name"},Mt={class:"label text-transform"},$t={class:"reception-filter-item-desc"},Tt={class:"desc"},Wt={class:"time"},Nt={class:"reception-panel-wrap"},Rt={class:"zent-tabs zent-tabs-type__normal reception-panel-tabs Panel-m_reception-panel-tabs_82Sn7"},At={class:"zent-tabs-nav zent-tabs-nav-type__normal zent-tabs-nav__stretch"},Ht={class:"zent-tabs-nav-content"},Ot={class:"zent-tabs-scroll",role:"tablist"},Bt={class:"zent-tabs-tab-inner"},Ft={class:"zent-tabs-tab-inner"},Vt={class:"reception-panel-toolbar"},Dt={class:"flex flex-justify-between"},Pt={class:"reception-panel-toolbar-waiting-count"},Ut={class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},Gt={class:"conversation-list"},Qt={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},qt=["onClick"],Jt={class:"conversation-list-item-mark"},Yt={class:"zent-tooltip-wrapper"},jt={class:""},Kt={class:"conversation-list-item-del"},Xt={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},Zt={class:"zent-badge-content"},es={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},ts=["src"],ss={key:1,class:"zent-avatar-image",src:P},os={key:0,class:"zent-badge-count"},ns={class:"conversation-list-item-content"},as={class:"conversation-list-item-line"},is={class:"conversation-list-item-name"},rs={class:"conversation-list-item-tag"},cs={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},ls={class:"zent-tag-content text-transform"},ds={class:"conversation-list-item-line"},vs={key:0,class:"conversation-list-item-message"},us={key:0},_s=["innerHTML"],hs={key:1},ms={class:"conversation-list-item-timestamp"},ps={key:1,class:"collapse-m_wrap_H4xuY reception-panel-ongoing"},gs={class:"conversation-list reception-panel-finished-list"},fs={key:0,style:{position:"relative",width:"280px",overflow:"auto","will-change":"transform",direction:"ltr"}},bs=["onClick"],ys={class:"conversation-list-item-mark"},ks={class:"zent-tooltip-wrapper"},zs={class:"zent-badge zent-badge--has-content conversation-list-item-avatar"},xs={class:"zent-badge-content"},ws={class:"zent-avatar zent-avatar--size-large zent-avatar--shape-circle zent-avatar--type-image"},Cs=["src"],Ss={key:1,class:"zent-avatar-image",src:P},Ls={key:0,class:"zent-badge-count"},Is={class:"conversation-list-item-content"},Es={class:"conversation-list-item-line"},Ms={class:"conversation-list-item-name"},$s={class:"conversation-list-item-tag"},Ts={class:"zent-tag zent-tag-style-grey-outline conversation-list-item-tag-default zent-tag-rounded"},Ws={class:"zent-tag-content text-transform"},Ns={class:"conversation-list-item-line"},Rs={key:0,class:"conversation-list-item-message"},As={class:"conversation-list-item-timestamp"},Hs=Xe(()=>e("div",{class:"im-resizable-anchor"},null,-1)),Os=$e({__name:"Index",emits:["update:isEditComment","successAdded","sendMessage"],setup(w,{emit:a}){const g=l(),f=l(),u=l(-1),x=l(1),U=l(!1),R=l(!1),A=t=>{x.value=t,t===1&&(I("tab"),U.value=!1),t===2&&(q("tab"),R.value=!1)},b=l(""),H=l(!1),G=l(null),_=l({conversationList:[],userList:[]}),pe=()=>{H.value=!0},ge=()=>{b.value==""&&_.value.conversationList.length==0&&_.value.userList.length==0&&(H.value=!1)},fe=()=>{b.value="",_.value={conversationList:[],userList:[]},G.value.focus()},be=async t=>{if(G.value.focus(),b.value!="")try{const s=await Ue({keyword:b.value});_.value=s.item,console.log(_.value)}catch(s){N.error(s.message)}finally{}},Z=l({}),C=l({}),L=(t,s)=>{var r;t!=-1?(C.value=t,u.value=t.id,t.unread_message_count>0&&(t.unread_message_count=0,(r=g.value)==null||r._setRead(t))):u.value=-1},ye=async t=>{console.log(t),Be.confirm("确认删除该会话?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{De({conversation_id:t.id}).then(s=>{C.value="",u.value=-1,I()}).catch(s=>{N.error(s.message)})})},ke=t=>{t&&(C.value.status=1,A(2),A(1))},v=l([]),Q=l([]),z=l(!1),I=async t=>{try{z.value=!0,console.log("====");const s=await he({status:1});v.value=s.filter_result,t!=="tab"&&s.filter_result.forEach(r=>{Number(r.unread_message_count)>0&&(U.value=!0)})}catch(s){N.error(s.message)}finally{z.value=!1}},q=async t=>{try{z.value=!0;const s=await he({status:2});Q.value=s.filter_result,console.log(R.value),t!=="tab"&&s.filter_result.forEach(r=>{Number(r.unread_message_count)>0&&(R.value=!0)})}catch(s){N.error(s.message)}finally{z.value=!1}},ze=async()=>{await I(),await q()},xe=t=>{},we=t=>{var r;const s=v.value.findIndex(O=>O.id===t.conversation_id);u.value>-1?(t.conversation_id===u.value?(Z.value=t,t.content.content_category==="end_conversation"&&(C.value.status=2)):s===-1&&ee(t),v.value[s].lastMessage[0]=t,v.value[s].unread_message_count++):s>-1?(v.value[s].lastMessage[0]=t,v.value[s].unread_message_count++):ee(t),t.content.content_category==="end_conversation"&&(v.value[s].status=2),(r=f.value)==null||r.play()},ee=t=>{const s={id:t.conversation_id,shop_id:t.shop_id,user_id:t.user_id,lastMessage:[t],unread_message_count:1,user:t.user,user_from:t.user_from};v.value=[s,...v.value],console.log("创建会话",s)},Ce=t=>{var r;const s=JSON.parse(t.data);s.type==="message"&&(console.log("message",s),s.data&&we(s.data[0])),s.type==="read"&&(console.log("read",s),s.data[0].shop_id===C.value.shop_id&&((r=g.value)==null||r.setReadOneself()))},Se=t=>{},Le=t=>{},E=new Ke(`${"wss://"+new URL(window.location.href).host+"/ws"}?token=${localStorage.getItem("accessToken")}&platform=admin`);E.onclose(Se),E.onopen(xe),E.onerror(Le),E.onmessage(Ce),E.connect();const J=l(0),te=l(null),Ie=async()=>{try{const t=qe();(await Ge({status:1})).errcode===0&&t.setImPresence(1);const r=await Qe({page:1});J.value=r.total,J.value>0&&Re(()=>{te.value.showWin()})}catch(t){N.error(t.message)}finally{}};Ae("receiveValueFromGrandChild",t=>{console.log("receiveValueFromGrandChild",t),v.value.map(s=>{s.id===t.conversation_id&&(s.lastMessage=[t])})});const se=Te().currentRoute.value.query;return We(async()=>{if(await Ie(),await I(),await q(),se.id){const t=v.value.find(s=>s.id===parseInt(se.id));console.log(t),t&&await L(t)}}),(t,s)=>{var ae,ie;const r=T("SvgIcon"),O=T("el-icon"),Ee=T("el-button"),oe=T("el-badge"),ne=T("a-spin");return n(),i("div",Ze,[e("div",et,[e("div",tt,[e("div",st,[e("div",ot,[e("div",nt,[e("span",at,[d(r,{name:"im-search",width:"16",height:"16"})]),B(e("input",{ref_key:"searchInput",ref:G,"onUpdate:modelValue":s[0]||(s[0]=o=>b.value=o),onFocus:pe,onBlur:ge,class:"super-search-box-module_input_3HdzN",placeholder:"搜索最近联系人、聊天记录"},null,544),[[Ne,b.value]]),B(e("div",it,[d(O,{onClick:de(fe,["stop","prevent"]),size:"13",color:"#797979"},{default:S(()=>[d(k(ue))]),_:1})],512),[[Y,b.value!=""]])]),B(d(Ee,{class:"super-search-btn",type:"primary",size:"mini",onClick:be},{default:S(()=>[_e("搜索")]),_:1},512),[[Y,H.value&&b.value!=""]])])]),B(e("div",rt,[e("div",ct,[_.value.userList.length>0?(n(),i("div",lt,[e("div",dt,"联系人("+c(((ae=_.value.userList)==null?void 0:ae.length)||0)+")",1),(n(!0),i(W,null,F(_.value.userList,(o,M)=>{var h,m,p;return n(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:$=>L(o)},[e("div",ut,[e("span",_t,[(h=o.user)!=null&&h.avatar?(n(),i("img",{key:0,class:"zent-avatar-image",src:k(D)((m=o.user)==null?void 0:m.avatar)},null,8,ht)):(n(),i("img",mt))])]),e("div",pt,[e("div",gt,[e("div",ft,c((p=o.user)==null?void 0:p.username),1),e("div",bt,c(o.user_from),1)])])],8,vt)}),128))])):y("",!0),_.value.conversationList.length>0?(n(),i("div",yt,[e("div",kt,"聊天记录("+c(((ie=_.value.conversationList)==null?void 0:ie.length)||0)+")",1),(n(!0),i(W,null,F(_.value.conversationList,(o,M)=>{var h,m,p;return n(),i("div",{class:"reception-filter-item cursor-pointer",key:M,onClick:$=>L(o)},[e("div",xt,[e("span",wt,[(h=o.user)!=null&&h.avatar?(n(),i("img",{key:0,class:"zent-avatar-image",src:k(D)((m=o.user)==null?void 0:m.avatar)},null,8,Ct)):(n(),i("img",St))])]),e("div",Lt,[e("div",It,[e("div",Et,c((p=o.user)==null?void 0:p.username),1),e("div",Mt,c(o.user_from),1)]),e("div",$t,[e("div",Tt,c(b.value),1),e("div",Wt,[d(k(K),{time:o.add_time},null,8,["time"])])])])],8,zt)}),128))])):y("",!0)])],512),[[Y,H.value]]),e("div",Nt,[e("div",Rt,[e("div",At,[e("div",Ht,[e("div",Ot,[e("div",{class:V(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":x.value===1}]),onClick:s[1]||(s[1]=o=>A(1))},[d(oe,{"is-dot":"",offset:[-80,15],color:U.value?"#f33":"#fff"},{default:S(()=>[e("div",Bt,"会话中("+c(v.value.length)+")",1)]),_:1},8,["color"])],2),e("div",{class:V(["zent-tabs-tab zent-tabs-tab-type__normal",{"zent-tabs-tab__actived":x.value===2}]),onClick:s[2]||(s[2]=o=>A(2))},[d(oe,{"is-dot":"",offset:[-80,15],color:R.value?"#f33":"#fff"},{default:S(()=>[e("div",Ft,"已结束("+c(Q.value.length)+")",1)]),_:1},8,["color"])],2)])])])]),x.value===1?(n(),i(W,{key:0},[e("div",Vt,[d(Pe,{ref_key:"CurrentQueueNumbererRef",ref:te,onClose:ze,style:{width:"100%"}},{default:S(()=>[e("div",Dt,[e("div",null,[_e(" 待接入数量："),e("span",Pt,c(J.value),1)]),d(r,{class:"zenticon zenticon-right",name:"im-arrow",width:"12",height:"12"})])]),_:1},512)]),e("div",Ut,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",Gt,[z.value?(n(),j(ne,{key:1,spinning:z.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(n(),i("div",Qt,[(n(!0),i(W,null,F(v.value,(o,M)=>{var h,m,p,$,re,ce,le;return n(),i("div",{class:V(["conversation-list-item",{"conversation-list-item-active":u.value==o.id}]),onClick:Me=>L(o)},[e("div",Jt,[e("div",Yt,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",jt,[e("div",Kt,[d(O,{onClick:de(Me=>ye(o),["stop","prevent"]),size:"20",color:"#bbbbbb"},{default:S(()=>[d(k(ue))]),_:2},1032,["onClick"])])]),e("div",Xt,[e("div",Zt,[e("span",es,[(h=o.user)!=null&&h.avatar?(n(),i("img",{key:0,class:"zent-avatar-image",src:k(D)((m=o.user)==null?void 0:m.avatar)},null,8,ts)):(n(),i("img",ss))]),o.unread_message_count>0?(n(),i("span",os,c(o.unread_message_count),1)):y("",!0)])]),e("div",ns,[e("div",as,[e("div",is,c(o.user?o.user.username:""),1),e("div",rs,[e("div",cs,[e("div",ls,c(o.user_from),1)])])]),e("div",ds,[o.lastMessage?(n(),i("div",vs,[((p=o.lastMessage[0])==null?void 0:p.message_type)=="text"?(n(),i("div",us,[e("div",{class:"conversation-list-item-message-text",innerHTML:(re=($=o.lastMessage[0])==null?void 0:$.content)==null?void 0:re.content},null,8,_s)])):(n(),i("div",hs,c((ce=o.lastMessage[0])==null?void 0:ce.message_type_text),1))])):y("",!0),e("div",ms,[d(k(K),{time:(le=o.lastMessage[0])==null?void 0:le.send_time},null,8,["time"])])])])],10,qt)}),256))]))])])])],64)):y("",!0),x.value===2?(n(),i("div",ps,[e("div",{class:"collapse-m_panel_2ePsT",style:ve([{"flex-basis":"40px"},"flex-grow: 6"])},[e("div",gs,[z.value?(n(),j(ne,{key:1,spinning:z.value,style:{width:"100%","margin-top":"100px",height:"200px"}},null,8,["spinning"])):(n(),i("div",fs,[(n(!0),i(W,null,F(Q.value,(o,M)=>{var h,m,p;return n(),i("div",{class:V(["conversation-list-item",{"conversation-list-item-active":u.value==o.id}]),onClick:$=>L(o,x.value)},[e("div",ys,[e("div",ks,[d(r,{class:"zenticon zenticon-star conversation-list-item-mark-star",name:"im-markstar",width:"10",height:"10"})])]),e("div",zs,[e("div",xs,[e("span",ws,[(h=o.user)!=null&&h.avatar?(n(),i("img",{key:0,class:"zent-avatar-image",src:k(D)((m=o.user)==null?void 0:m.avatar)},null,8,Cs)):(n(),i("img",Ss))]),o.unread_message_count>0?(n(),i("span",Ls,c(o.unread_message_count),1)):y("",!0)])]),e("div",Is,[e("div",Es,[e("div",Ms,c(o.user?o.user.username:""),1),e("div",$s,[e("div",Ts,[e("div",Ws,c(o.user_from),1)])])]),e("div",Ns,[o.lastMessage?(n(),i("div",Rs,c(((p=o.lastMessage[0].content)==null?void 0:p.content)||o.lastMessage[0].message_type_text),1)):y("",!0),e("div",As,[d(k(K),{time:o.add_time},null,8,["time"])])])])],10,bs)}),256))]))])])])):y("",!0)])]),Hs,u.value?(n(),j(Ve,{key:0,ref_key:"ImMessageRef",ref:g,conversationId:u.value,"onUpdate:conversationId":s[3]||(s[3]=o=>u.value=o),currentNewMessage:Z.value,currentConversationData:C.value,msgType:x.value,onResumeConversation:ke,on_getConversationStrat:I},null,8,["conversationId","currentNewMessage","currentConversationData","msgType"])):y("",!0)]),d(Je,{ref_key:"promptToneRef",ref:f},null,512)])}}});const go=Fe(Os,[["__scopeId","data-v-e7e92c40"]]);export{go as default};
