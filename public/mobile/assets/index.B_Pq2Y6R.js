import{Y as e,e as a,r as t,ax as l,q as i,aq as s,y as o,c as r,o as u,i as c,w as n,a as v,a9 as d,z as p,U as h,B as f,V as y,aw as b,d as g,T as m,b as k,t as S,H as x,aA as T,aB as z,bo as w,_,bc as C,A as O,u as I,E as j,bp as $,L as M}from"./index-BKzbZvRR.js";import{b as E,a as N}from"./tig-layout.BpNdXByQ.js";const q=_(a({__name:"VerifySlide",props:{captchaType:{type:String,default:"blockPuzzle"},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},explain:{type:String,default:"向右拖动滑块填充拼图"},blockSize:{type:Object,default:()=>({width:50,height:50})},barSize:{type:Object,default:()=>({width:"310px",height:"40px"})},barMarginTop:{type:Number,default:8}},emits:["close","success"],setup(a,{expose:_,emit:C}){const O=a,I=C,j=t(!1),$=t(""),M=t(""),E=t(""),N=t(""),q=t(""),D=t(0),A=async()=>{try{const t=await(a={captchaType:O.captchaType},e({url:"common/verification/captcha",method:"POST",data:a}));$.value=t.originalImageBase64,M.value=t.jigsawImageBase64,E.value=t.token,N.value=t.secretKey}catch(t){console.error(t),q.value=t.message}var a},B=t(!1),J=t(""),P=t(""),V=t(""),F=t(""),X=t("#ddd"),R=t("#d1e0f1"),U=t(""),G=t("icon-right"),H=t(!1),K=t(!1),L=t(""),Y=t(""),Q=t(0),W=t(""),Z=t({left:0,top:0,width:0,height:0}),ee=t(0),ae=z(),te={active:{block:"#1991fa",border:"#1991fa",background:"#d1e0f1",icon:"#fff"},success:{block:"#52ccba",border:"#52ccba",background:"#d2f4ef",icon:"#fff"},error:{block:"#d9534f",border:"#d9534f",background:"#fce1e1",icon:"#fff"},default:{block:"#fff",border:"#ddd",background:"#d1e0f1",icon:"#666"}},le=e=>{const a=te[e];F.value=a.block,X.value=a.border,R.value=a.background,U.value=a.icon},ie=e=>{try{if(K.value)return;const a=e.touches[0].clientX;Q.value=Math.floor(a-Z.value.left),D.value=Date.now(),W.value="",le("active"),H.value=!0}catch(a){console.error("滑块验证初始化错误:",a)}},se=e=>{var a,t;try{if(!H.value||K.value)return;const l=e.touches[0].clientX,i=(null==(a=Z.value)?void 0:a.left)||0,s=parseInt(O.blockSize.width)/2,o=((null==(t=Z.value)?void 0:t.width)||0)-s-2;let r=l-i;r=Math.max(s,Math.min(r,o));const u=r-Q.value;P.value=`${u}px`,V.value=`${u+40}px`}catch(l){console.error("滑块移动处理错误:",l)}},oe=e=>{try{if(ee.value=Date.now(),!H.value||K.value)return;const e=re();ce(e)}catch(a){console.error("滑块验证结束处理错误:",a),ve()}},re=()=>310*parseInt((P.value||"0").replace("px",""))/(parseInt(O.imgSize.width)||310),ue=e=>{const a={x:e,y:5};return N.value?w(JSON.stringify(a),N.value):JSON.stringify(a)},ce=async a=>{try{const t={captchaType:O.captchaType,pointJson:ue(a),token:E.value},l=await(a=>e({url:"common/verification/check",method:"POST",data:a}))(t);if(console.log("验证结果:",l),l.token){le("success"),G.value="icon-check",B.value=!1,K.value=!0,j.value=!0;const e=((ee.value-D.value)/1e3).toFixed(2);q.value=`${e}s验证成功`;const t={x:a,y:5},l=JSON.stringify(t),i=N.value?w(E.value+"---"+l,N.value):E.value+"---"+l;setTimeout((()=>{q.value="",I("close"),I("success",{verifyToken:i})}),1e3)}else ne()}catch(t){console.error(t),ne()}finally{H.value=!1}},ne=()=>{le("error"),G.value="icon-close",j.value=!1,setTimeout((()=>ve()),1e3),q.value="验证失败",setTimeout((()=>{q.value=""}),1e3)},ve=()=>{B.value=!0,J.value="",L.value="left .3s",P.value="",V.value="",Y.value="width .3s",le("default"),G.value="icon-right",K.value=!1,A(),setTimeout((()=>{Y.value="",L.value="",W.value=O.explain}),300)};return l((()=>{A(),setTimeout((()=>{(async()=>{try{const e=await T(".verify-bar-area",ae);e&&(Z.value=e)}catch(e){console.error(e)}})()}),350)})),_({refresh:ve}),(e,t)=>{const l=f,T=c,z=g,w=i(o("up-transition"),s);return u(),r(T,{class:"verifyslide"},{default:n((()=>[v(T,{class:"verify-img-out",style:d({height:parseInt(a.imgSize.height)+"px"})},{default:n((()=>[v(T,{class:"verify-img-panel",style:d({width:a.imgSize.width,height:a.imgSize.height})},{default:n((()=>[$.value?(u(),r(l,{key:0,src:"data:image/png;base64,"+$.value,class:"img"},null,8,["src"])):p("",!0),$.value?h((u(),r(T,{key:1,class:"verify-refresh",onClick:ve},{default:n((()=>[b("i",{class:"iconfont-pc icon-refresh"})])),_:1},512)),[[y,B.value]]):p("",!0),v(w,{show:!!q.value,mode:"fade-up"},{default:n((()=>[v(z,{class:m("verify-tips "+(j.value?"suc-bg":"err-bg"))},{default:n((()=>[k(S(q.value),1)])),_:1},8,["class"])])),_:1},8,["show"])])),_:1},8,["style"])])),_:1},8,["style"]),v(T,{class:"verify-bar-area",style:d({width:a.imgSize.width,height:a.barSize.height,"line-height":a.barSize.height,marginTop:a.barMarginTop+"px"})},{default:n((()=>[v(z,{class:"verify-msg"},{default:n((()=>[k(S(W.value),1)])),_:1}),v(T,{class:"verify-left-bar",style:d({width:void 0!==V.value?V.value:a.barSize.height,height:a.barSize.height,"border-color":X.value,"background-color":R.value,transition:Y.value})},{default:n((()=>[v(z,{class:"verify-msg",textContent:S(J.value)},null,8,["textContent"]),v(T,{class:"verify-move-block",onTouchstart:ie,onTouchmove:x(se,["stop","prevent"]),onTouchend:oe,style:d({width:a.barSize.height,height:a.barSize.height,"background-color":F.value,left:P.value,transition:L.value})},{default:n((()=>[b("i",{class:m(["verify-icon iconfont-pc",G.value]),style:d({color:U.value})},null,6),v(T,{class:"verify-sub-block",style:d({width:Math.floor(47*parseInt(a.imgSize.width)/310)+"px",height:a.imgSize.height,top:"-"+(parseInt(a.imgSize.height)+a.barMarginTop)+"px","background-size":a.imgSize.width+" "+a.imgSize.height})},{default:n((()=>[M.value?(u(),r(l,{key:0,src:"data:image/png;base64,"+M.value,class:"img"},null,8,["src"])):p("",!0)])),_:1},8,["style"])])),_:1},8,["style"])])),_:1},8,["style"])])),_:1},8,["style"])])),_:1})}}}),[["__scopeId","data-v-974723ab"]]),D=_(a({__name:"Verify",props:{captchaType:{type:String,required:!0},figure:{type:Number},arith:{type:Number},mode:{type:String,default:"pop"},vSpace:{type:Number},explain:{type:String},imgSize:{type:Object,default:()=>({width:"310px",height:"155px"})},blockSize:{type:Object},barSize:{type:Object},close:{type:Function}},emits:["okCallback"],setup(e,{expose:a,emit:l}){const s=e,{captchaType:d,figure:h,arith:f,mode:y,vSpace:b,explain:g,imgSize:m,blockSize:x,barSize:T}=C(s),z=t({}),w=l,_=t(!1),I=()=>{_.value=!1,z.value.refresh&&z.value.refresh()},j=e=>{w("okCallback",e)};return a({show:()=>{_.value=!0}}),(e,a)=>{const t=c,l=i(o("tig-popup"),E);return u(),r(l,{maskClick:!1,show:_.value,"onUpdate:show":a[0]||(a[0]=e=>_.value=e),customStyle:{width:O(m).width,"box-sizing":"content-box",padding:"10rpx 30rpx"},position:"center"},{default:n((()=>[v(t,{class:"content"},{default:n((()=>[v(t,{class:"title"},{default:n((()=>[k(S(e.$t("请完成安全验证")),1)])),_:1}),_.value?(u(),r(q,{key:0,captchaType:O(d),type:"2",figure:O(h),arith:O(f),mode:O(y),vSpace:O(b),explain:O(g),imgSize:O(m),blockSize:O(x),barSize:O(T),ref_key:"instance",ref:z,onClose:I,onSuccess:j},null,8,["captchaType","figure","arith","mode","vSpace","explain","imgSize","blockSize","barSize"])):p("",!0)])),_:1})])),_:1},8,["show","customStyle"])}}}),[["__scopeId","data-v-6ec43db0"]]),A=_(a({__name:"index",props:{class:String,mobile:{type:String,default:""},requestApi:{type:Function,required:!0},isChecked:{type:Boolean,default:!1},verifyTokenData:{type:String,default:null},event:{type:String,default:"login"},btnType:{type:String,default:"button"}},emits:["mobileErrorCallback","update:isChecked","update:verifyTokenData"],setup(e,{emit:a}){const l=I(),{t:s}=j(),d=e,h=a,{mobile:f}=C(d),y=t(),b=t(""),g=t(!1),m=t(null),x=t(),T=()=>{g.value=!1},z=()=>{g.value=!0},w=async()=>{if(!1===d.isChecked)return h("mobileErrorCallback",s("请阅读并同意协议！"));g.value||(""!=f.value?E(f.value)?m.value?_():x.value.show():h("mobileErrorCallback",s("手机号格式错误")):h("mobileErrorCallback",s("手机号不能为空！")))},_=async()=>{try{await d.requestApi({mobile:f.value,verifyToken:m.value,event:d.event}),h("update:verifyTokenData",m.value),M({title:s("验证码已发送"),duration:1500}),y.value.canGetCode&&y.value.start()}catch(e){h("mobileErrorCallback",e.message),h("update:verifyTokenData","")}finally{m.value=null}},O=e=>{b.value=e},E=e=>!!(l.isOpenMobileAreaCode?/^[1-9]\d{10,14}$/:/^(?:(?:\+|00)86)?1\d{10}$/).test(e),q=e=>{m.value=e.verifyToken,w()};return(a,t)=>{const l=i(o("tig-button"),N),s=c,d=i(o("up-code"),$);return u(),r(s,{class:"box"},{default:n((()=>["button"===e.btnType?(u(),r(l,{key:0,onClick:w,plain:!0,disabled:g.value,class:"btn-verify"},{default:n((()=>[k(S(b.value),1)])),_:1},8,["disabled"])):p("",!0),"text"===e.btnType?(u(),r(s,{key:1,onClick:w,plain:!0,disabled:g.value,class:"verify-btn"},{default:n((()=>[k(S(b.value),1)])),_:1},8,["disabled"])):p("",!0),v(d,{seconds:60,onEnd:T,onStart:z,ref_key:"uCodeRef",ref:y,startText:a.$t("获取验证码"),endText:a.$t("重新获取"),changeText:a.$t("X秒重新获取"),onChange:O},null,8,["startText","endText","changeText"]),v(D,{ref_key:"verifyRef",ref:x,mode:"pop",captchaType:"blockPuzzle",imgSize:{width:"310px",height:"155px"},onOkCallback:q},null,512)])),_:1})}}}),[["__scopeId","data-v-fa81b598"]]);export{A as V,D as a};
